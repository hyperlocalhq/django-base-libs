{% extends "productions/events/base.html" %}
{% load base_tags crispy_forms_tags i18n sekizai_tags %}

{% block stylesheet %}
    {{ block.super }}
    <link href="{{ STATIC_URL }}site/js/autocomplete_1.0/jquery.autocomplete.css" rel="stylesheet" />
{% endblock %}

{% block script %}
    {{ block.super }}
    <script src="{{ STATIC_URL }}site/js/autocomplete_1.0/jquery.bgiframe.min.js"></script>
    <script src="{{ STATIC_URL }}site/js/autocomplete_1.0/jquery.autocomplete.js"></script>
    <script src="{{ STATIC_URL }}site/js/autocomplete.js"></script>
{% endblock %}

{% block event_tabs %}
    {% if 'new_production=1' in request.get_full_path %}
        <li class="active"><a class="txt" href="{% url "change_event_basic_info" slug=production.slug event_id=event.pk %}?new_production=1"> {% trans "Details" %} </a></li>
        <li><a class="txt" href="{% url "change_event_description" slug=production.slug event_id=event.pk %}?new_production=1"> {% trans "Description" %} </a></li>
        <li><a class="txt" href="{% url "change_event_gallery" slug=production.slug event_id=event.pk %}?new_production=1"> {% trans "Media" %} </a></li>
    {% else %}
        <li class="active"><a class="txt" href="{% url "change_event_basic_info" slug=production.slug event_id=event.pk %}"> {% trans "Details" %} </a></li>
        <li><a class="txt" href="{% url "change_event_description" slug=production.slug event_id=event.pk %}"> {% trans "Description" %} </a></li>
        <li><a class="txt" href="{% url "change_event_gallery" slug=production.slug event_id=event.pk %}"> {% trans "Media" %} </a></li>
    {% endif %}
{% endblock %}

{% block multistep_form %}
    {% crispy form %}
    <script src="https://maps.google.com/maps/api/js?language={{ LANGUAGE_CODE }}&amp;region=DE&amp;key={{ GOOGLE_API_KEY }}"></script>
    <script src="{{ STATIC_URL }}site/js/locating.min.js"></script>
    <script src="{{ STATIC_URL }}site/js/checkbox-tree.js"></script>
    {% now "uuuu" as microseconds %}
    <script nonce="{{ microseconds|to_base64 }}">
        $(function() {
            $('body').on('change', '.autocomplete-light-widget select[name$=play_locations],.autocomplete-light-widget select[name$=in_program_of]', function() {
                var $this = $(this);
                var $inProgramOfSelectElement = $('#' + $this.attr('id').replace(/play_locations/, 'in_program_of'));
                var $locationsSelectElement = $('#' + $this.attr('id').replace(/in_program_of/, 'play_locations'));
                var $stagesSelectElement = $('#' + $this.attr('id').replace(/play_locations|in_program_of/, 'play_stages'));
                var $stagesWidgetElement = $stagesSelectElement.closest('.autocomplete-light-widget');

                var values = []
                if ($inProgramOfSelectElement.val()) {
                    values = values.concat($inProgramOfSelectElement.val());
                }
                if ($locationsSelectElement.val()) {
                    values = values.concat($locationsSelectElement.val());
                }

                if (values) {
                    // If value contains something, add it to autocomplete.data
                    $stagesWidgetElement.yourlabsWidget().autocomplete.data = {
                        'location_ids': values.join(',')
                    };
                } else {
                    // If value is empty, empty autocomplete.data
                    $stagesWidgetElement.yourlabsWidget().autocomplete.data = {};
                }
            });
            $('.autocomplete-light-widget select[name$=play_locations],.autocomplete-light-widget select[name$=in_program_of]').trigger('change')

            $('.enter_location').on('click', function(e) {
                e.preventDefault();
                var oGmap = $('.fieldset-where').removeClass('hidden').find('.map_canvas').data('gmap');
                google.maps.event.trigger(oGmap, 'resize');
            });
            if ($('#id_location_title').val()) {
                $('.enter_location:first').trigger('click');
            }
        });
        $('.dateinput').datepicker({
            format: 'yyyy-mm-dd',
            weekStart: 1
        });
        $('.timeinput').timepicker({
            str_hours: '{% trans "Hours" %}',
            str_minutes: '{% trans "Minutes" %}',
            str_confirm: '{% trans "Confirm" %}',
            str_close: '{% trans "Close" %}'
        });
    </script>
    {% add_data "script_nonces" microseconds|to_base64 %}
{% endblock %}
