// some very small jquery extensions
(function(t){function r(e,n,r,i,s){function o(n,r){var s=!0;i&&(s=i(n,r));if(s){/page_\d+/.test(t(e).attr("id"))?target=t(e).find("div.cont:first"):target=t(e).parents("div.cont:first");var o=target.parent();if(n=="NotFound")return o.remove();var u=t(".messagelist");target.replace(n);var a=t(o).find(".messagelist");if(a.length){u.remove();a.insertAfter(".breadcrumbs")}o.find("div.cont:first").yft()}return!0}function u(e,t,n){s&&s(e,t,n)}r===undefined&&(r={});/\/\?/ig.test(window.location.href)&&(r.filtered=1);t.ajax({data:r,success:o,error:u,type:"POST",url:n,xhr:window.ActiveXObject?function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}:function(){return new window.XMLHttpRequest}})}function i(e,n,i,s,o){r(e,"./"+n+"/move-page/",{position:s,target:i},function(e,r){response=e.content;status=e.status;if(status==200){if(o){var u={left:"before",right:"after"}[s]||"inside";o.moved("#page_"+n,t("#page_"+i+" a.title")[0],u,!1,!1)}else moveSuccess(t("#page_"+n+" div.col1:eq(0)"));return!1}moveError(t("#page_"+n+" div.col1:eq(0)"),response);return!1})}function o(e,t,n){s.push({node:e,target:t,position:n})}t.fn.yft=function(){this.effect("highlight",{},1e3)};t.fn.replace=function(e){return this.after(e).remove().end()};var n;initTree=function(){n=new tree_component;var e={rules:{clickable:"all",renameable:"none",deletable:"all",creatable:"all",draggable:"all",dragrules:"all",droppable:"all",metadata:"mdata",use_inline:!0},path:!1,ui:{dots:!0,rtl:!1,animation:0,hover_mode:!0,theme_path:!1,theme_name:"default",a_class:"title"},cookies:{prefix:"djangocms_nodes"},callback:{beforemove:function(e,n,r){item_id=e.id.split("page_")[1];target_id=n.id.split("page_")[1];old_node=e;if(t(e).parent().children("li").length>1){if(t(e).next("li").length){old_target=t(e).next("li")[0];old_position="right"}if(t(e).prev("li").length){old_target=t(e).prev("li")[0];old_position="left"}}else if(t(e).attr("rel")!="topnode"){old_target=t(e).parent().parent()[0];old_position="inside"}o(e,n,r);return!0},onmove:function(e,t,n){item_id=e.id.split("page_")[1];target_id=t.id.split("page_")[1];n=="before"?n="left":n=="after"?n="right":n=="inside"&&(n="last-child");i(e,item_id,target_id,n,!1)},onchange:function(e){url=t(e).find("a.title").attr("href");window.location=url}}};t(t("div.tree").get(0)).hasClass("root_allow_children")||(e.rules.dragrules=["node inside topnode","topnode inside topnode","node * node"]);n.init(t("div.tree"),e)};t(document).ready(function(){function s(){window.location=window.location.href}function o(e){return t("#page_"+e).find("li[id^=page_]").length?s:function(){return!0}}function u(e,n,r,i){n===undefined&&(n={});t.post(e,n,function(e){e==""&&r&&r();t("#dialogs").empty().append(e);i&&i(e)})}function a(){t("#sitemap ul .col-actions").syncWidth(0);t("#sitemap ul .col-published").syncWidth(0);t("#sitemap ul .col-navigation").syncWidth(0);t("#sitemap ul .col-softroot").syncWidth(0);t("#sitemap ul .col-template").syncWidth(0);t("#sitemap ul .col-creator").syncWidth(0);t("#sitemap ul .col-view-perms").syncWidth(0);t("#sitemap ul .col-lastchange").syncWidth(0);t("#sitemap ul .col-draft").syncWidth(0)}function h(e,n,r,i){return cmsSettings.cmsPermission||cmsSettings.cmsModerator?u("./"+e+"/dialog/copy/",{position:r,target:n,site:i,callback:t.callbackRegister("_copyTreeItem",p,e,n,r,i)}):p(e,n,r,i)}function p(e,n,r,i,s){var o={position:r,target:n,site:i};o=t.extend(o,s);t.post("./"+e+"/copy-page/",o,function(n){response=n.content;status=n.status;if(status==200)window.location=window.location.href;else{alert(response);moveError(t("#page_"+e+" div.col1:eq(0)"),response)}})}function d(e){t("a.move-target, span.move-target-container, span.line").show();t("#page_"+e).addClass("selected");t("#page_"+e).parent().parent().children("div.cont").find("a.move-target.first-child, span.second").hide();t("#page_"+e).parent().parent().children("ul").children("li").children("div.cont").find("a.move-target.left, a.move-target.right, span.first, span.second").hide();return"copy"}selected_page=!1;c=!1;var e=t.ajax;t.ajax=function(n){t("#loader-message").show();callback=n.success||!1;n.success=function(e,n){callback&&callback(e,n);t("#loader-message").hide();a()};return e(n)};t("#changelist li").click(function(e){e.target.tagName=="IMG"||e.target.tagName=="SPAN"?target=e.target.parentNode:target=e.target;var s=t(target);if(s.hasClass("move")){var u=e.target.id.split("move-link-")[1];u==null&&(u=e.target.parentNode.id.split("move-link-")[1]);var a=u;selected_page=a;c="move";t("span.move-target-container, span.line, a.move-target").show();t("#page_"+a).addClass("selected");t("#page_"+a+" span.move-target-container").hide();e.stopPropagation();return!1}if(s.hasClass("copy")){u=e.target.id.split("copy-link-")[1];u==null&&(u=e.target.parentNode.id.split("copy-link-")[1]);selected_page=u;c=d(u);e.stopPropagation();return!1}if(s.hasClass("viewpage")){var f=t("#"+target.id+"-select").val();f&&window.open(f)}if(s.hasClass("addlink")){if(!/#$/g.test(s.attr("href")))return!0;t("tr").removeClass("target");t("#changelist table").removeClass("table-selected");a=target.id.split("add-link-")[1];selected_page=a;c="add";t("tr").removeClass("selected");t("#page-row-"+a).addClass("selected");t(".move-target-container").hide();t("a.move-target, span.line, #move-target-"+a).show();e.stopPropagation();return!1}admin_base_url=document.URL.split("/cms/page/")[0]+"/";if(s.hasClass("publish-checkbox")){l=s.attr("name").split("status-")[1];r(s,admin_base_url+"cms/page/"+l+"/change-status/",{1:1},o(l));e.stopPropagation();return!1}if(s.hasClass("navigation-checkbox")){l=s.attr("name").split("navigation-")[1];r(s,admin_base_url+"cms/page/"+l+"/change-navigation/",{1:1});e.stopPropagation();return!0}if(s.hasClass("publish")){l=s.parents("li[id^=page_]").attr("id").split("_")[1];r(s,admin_base_url+"cms/page/"+l+"/publish/?node=1",{},o(l));e.stopPropagation();return!1}if(s.hasClass("closed")&&s.find("ul > li").length==0&&!s.hasClass("loading")){s.addClass("loading");var l=t(s).attr("id").split("page_")[1];t.get(admin_base_url+"cms/page/"+l+"/descendants/",{},function(e,n){s.children("ul").append(e);t("span.move-target-container:visible").length>0&&s.children("ul").find("a.move-target, span.move-target-container, span.line").show()})}if(s.hasClass("move-target")){s.hasClass("left")&&(position="left");s.hasClass("right")&&(position="right");s.hasClass("last-child")&&(position="last-child");target_id=target.parentNode.id.split("move-target-")[1];if(c=="move"){i(null,selected_page,target_id,position,n);t(".move-target-container").hide()}else if(c=="copy"){site=t("#site-select")[0].value;h(selected_page,target_id,position,site);t(".move-target-container").hide()}else if(c=="add"){site=t("#site-select")[0].value;window.location.href=window.location.href.split("?")[0].split("#")[0]+"add/?target="+target_id+"&amp;position="+position+"&amp;site="+site}e.stopPropagation();return!1}return!0});t.fn.syncWidth=function(e){t(this).each(function(){var n=t(this).width();n>e&&(e=n)});t(this).each(function(){t(this).css("width",e+"px")});return this};t("div#sitemap").show();a();t("#site-select").change(function(e){var t=this.value,n=window.location.href;c=="copy"?n=CMS.API.Helpers.setUrl(document.location,{addParam:"copy="+selected_page,removeParam:"copy"}):n=CMS.API.Helpers.setUrl(document.location,{addParam:"copy",removeParam:"copy"});n=CMS.API.Helpers.setUrl(document.location,{addParam:"site__exact="+t,removeParam:"site__exact"});window.location.href=n});var f=window.location.href.split("copy=");if(f.length>1){var l=f[1].split("&")[0],c=d(l);selected_page=l}t("div.col-moderator input").livequery(function(){t(this).checkBox({addLabel:!1})})});var s=[]})(window.CMS.$);