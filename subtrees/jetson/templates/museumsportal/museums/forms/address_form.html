{% extends "museums/forms/base.html" %}
{% load crispy_forms_tags i18n %}

{% block stylesheet %}
    {{ block.super }}
    <link href="{{ STATIC_URL }}site/js/autocomplete_1.0/jquery.autocomplete.css" rel="stylesheet" />
{% endblock %}

{% block js %}
    {{ block.super }}
    <script src="{{ STATIC_URL }}site/js/autocomplete_1.0/jquery.bgiframe.min.js"></script>
    <script src="{{ STATIC_URL }}site/js/autocomplete_1.0/jquery.autocomplete.js"></script>
    <script src="{{ STATIC_URL }}site/js/autocomplete.js"></script>
{% endblock %}

{% block multistep_form %}
{% crispy form %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&amp;language={{ LANGUAGE_CODE }}&amp;region=DE"></script>
<script type="text/javascript" src="{{ STATIC_URL }}site/js/gmaps_for_address.js"></script>
<script type="text/javascript">
(function($, undefined) {
    function reinit_widgets() {
        $('[rel=tooltip]').tooltip();
        $('[id^="id_social"][id$="channel_type"]').autocomplete(['Google+', 'Twitter', 'Facebook', 'LinkedIn', 'XING']);
    }
    
    function set_index_for_fields($formset_form, index) {
        $formset_form.find(':input').each(function() {
            var $field = $(this);
            if ($field.attr("id")) {
                $field.attr(
                    "id",
                    $field.attr("id").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
            if ($field.attr("name")) {
                $field.attr(
                    "name",
                    $field.attr("name").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
        });
        $formset_form.find('label').each(function() {
            var $field = $(this);
            if ($field.attr("for")) {
                $field.attr(
                    "for",
                    $field.attr("for").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
        });
        $formset_form.find('div').each(function() {
            var $field = $(this);
            if ($field.attr("id")) {
                $field.attr(
                    "id",
                    $field.attr("id").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
        });
    }
        
    $(function() {
        $(
            '<a class="add btn btn-primary" id="add_social" href="#">{% trans "Add social media channel" %}</a>'
        ).insertAfter('#social').click(function() {
            var $total_forms = $('#id_social-TOTAL_FORMS');
            var $new_form = $('#social_empty_form').clone(true).attr("id", null).show();
            set_index_for_fields($new_form, parseInt($total_forms.val(), 10));
            $('#social').append($new_form);
            $total_forms.val(parseInt($total_forms.val(), 10) + 1);
            reinit_widgets();
            return false;
        });
        
        $('.formset-form').each(function() {
            var $season = $(this);
            $season.find('input:checkbox[id$=DELETE]').each(function() {
                var $checkbox = $(this);
                var $deleteLink = $(
                    '<div class"min"><button class="delete icon icon-black icon-delete" data-toggle="tooltip" data-placement="top" data-original-title="{% trans "Delete" %}">Delete</button></div>'
                );
                $checkbox.parents('.formset-form').find(".row").append($deleteLink);
                $checkbox.parent().hide();
            });
        });
        $('.delete').live("click", function() {
            var $season = $(this).parents('.formset-form:first');
            var $checkbox = $season.find('input:checkbox[id$=DELETE]');
            $checkbox.attr("checked", "checked");
            $season.hide();
            return false;
        });
        
        // Initial state
        var $total_forms = $('#id_social-TOTAL_FORMS');
        if ($total_forms.val() == "0") {
            $('#add_social').click();
        }
        reinit_widgets();
        
        $('#id_parent').change(function() {
            if ($(this).val()) {
                $.get('/helper/museum_attrs/' + $(this).val() + '/', function(data) {
                    $('#id_street_address').val(data['street_address']).addClass("noneditable");
                    $('#id_street_address2').val(data['street_address2']).addClass("noneditable");
                    $('#id_postal_code').val(data['postal_code']).addClass("noneditable");
                    $('#id_city').val(data['city']).addClass("noneditable");
                    $('#id_latitude').val(data['latitude']).addClass("noneditable");
                    $('#id_longitude').val(data['longitude']).addClass("noneditable");
                    $('#dyn_locate_geo').click();
                }, 'json');
            }
        });

    });
})(jQuery);
</script>
{% endblock %}
