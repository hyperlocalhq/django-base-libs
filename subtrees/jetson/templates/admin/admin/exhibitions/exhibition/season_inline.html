{% load url from future %}
{% load i18n grp_tags %}

<!-- group -->
<div class="grp-group grp-stacked {% if inline_admin_formset.opts.classes %} {{ inline_admin_formset.opts.classes|join:" " }}{% endif %}"
    id="{{ inline_admin_formset.formset.prefix }}-group">
    <h2 class="grp-collapse-handler">{% if inline_admin_formset.opts.title %}{{ inline_admin_formset.opts.title }}{% else %}{{ inline_admin_formset.opts.verbose_name_plural|capfirst }}{% endif %}</h2>
    <ul class="grp-tools">
        <li><a href="javascript://" class="grp-icon grp-open-handler" title="{% trans 'Open All Items' %}"></a></li>
        <li><a href="javascript://" class="grp-icon grp-close-handler" title="{% trans 'Close All Items' %}"></a></li>
        <li><a href="javascript://" class="grp-icon grp-add-handler" title="{% trans 'Add Item' %}"> </a></li>
    </ul>
    {{ inline_admin_formset.formset.management_form }}
    {{ inline_admin_formset.formset.non_form_errors }}
    <!-- container -->
    <div class="grp-items">
        {% for form in inline_admin_formset.formset %}
            <!-- element -->
            <div class="grp-module {{ inline_admin_formset.opts.inline_classes|join:" "|default:"grp-collapse grp-closed" }}{% if form.instance or inline_admin_form.show_url %} has_original{% endif %}" id="{{ inline_admin_formset.formset.prefix }}{{ forloop.counter0 }}">
                <h3 class="grp-collapse-handler">{{ inline_admin_formset.opts.verbose_name|title }}&nbsp;&nbsp;{% if form.instance %}{{ form.instance }}{% endif %}</h3>
                <ul class="grp-tools">
                    {% if form.instance %}
                        <li><input id="id_season_set-{{ forloop.counter0 }}-DELETE" type="checkbox" class="form_checkbox" name="season_set-{{ forloop.counter0 }}-DELETE" /><a href="javascript://" class="grp-icon grp-delete-handler" title="{% trans 'Delete Item' %}"></a></li>
                    {% else %}
                        <li><input id="id_season_set-{{ forloop.counter0 }}-DELETE" type="checkbox" class="form_checkbox" name="season_set-{{ forloop.counter0 }}-DELETE" /><a href="javascript://" class="grp-icon grp-remove-handler" title="{% trans 'Delete Item' %}"></a></li>
                    {% endif %}
                </ul>
                {% if form.non_field_errors %}
                    <ul class="grp-errorlist">
                        <li>{{ form.non_field_errors }}</li>
                    </ul>
                {% endif %}
                {% with forloop.counter0 as counter %}
                    {% include "admin/exhibitions/exhibition/fieldset_opening_hours.html" %}
                {% endwith %}
                <input id="id_season_set-{{ forloop.counter0 }}-id" type="hidden" class="form_hidden" value="{{ form.instance.id }}" name="season_set-{{ forloop.counter0 }}-id" />
                <input id="id_season_set-{{ forloop.counter0 }}-museum" type="hidden" class="form_hidden" value="{{ form.instance.museum.id }}" name="season_set-{{ forloop.counter0 }}-museum" />
            </div>
        {% endfor %}
        {% with inline_admin_formset.formset.empty_form as form %}
            <!-- element -->
            <div class="grp-module grp-collapse grp-empty-form grp-open" id="season_set-empty">
                <h3 class="grp-collapse-handler">{{ inline_admin_formset.opts.verbose_name|title }}</h3>
                <ul class="grp-tools">
                    {% if inline_admin_formset.formset.can_delete %}
                        <li class="remove-handler-container">{{ inline_admin_form.deletion_field.field }}<a href="javascript://" class="grp-icon grp-remove-handler" title="{% trans 'Delete Item' %}"></a></li>
                    {% endif %}
                </ul>
                {% if inline_admin_form.form.non_field_errors %}
                    <ul class="errorlist">
                        <li>{{ inline_admin_form.form.non_field_errors }}</li>
                    </ul>
                {% endif %}
                {% with "__prefix__" as counter %}
                    {% include "admin/exhibitions/exhibition/fieldset_opening_hours.html" %}
                {% endwith %}
            </div>
        {% endwith %}
    </div>
    <div class="grp-module grp-transparent">
        <div class="grp-row">
            <a href="javascript://" class="grp-add-handler"><strong>{% blocktrans with inline_admin_formset.opts.verbose_name|title as verbose_name %}Add another {{ verbose_name }}{% endblocktrans %}</strong></a>
            <ul class="grp-tools">
                <li><a href="javascript://" class="grp-icon grp-add-handler" title="{% trans 'Add Item' %}"> </a></li>
            </ul>
        </div>
    </div>
</div>

<script type="text/javascript">
(function($) {
    $(document).ready(function() {
        
        var prefix = "{{ inline_admin_formset.formset.prefix }}";
        var related_lookup_fields_fk = {% get_related_lookup_fields_fk inline_admin_formset.opts %};
        var related_lookup_fields_m2m = {% get_related_lookup_fields_m2m inline_admin_formset.opts %};
        var related_lookup_fields_generic = {% get_related_lookup_fields_generic inline_admin_formset.opts %};
        var autocomplete_fields_fk = {% get_autocomplete_lookup_fields_fk inline_admin_formset.opts %};
        var autocomplete_fields_m2m = {% get_autocomplete_lookup_fields_m2m inline_admin_formset.opts %};
        var autocomplete_fields_generic = {% get_autocomplete_lookup_fields_generic inline_admin_formset.opts %};
        $.each(related_lookup_fields_fk, function() {
            $("#{{ inline_admin_formset.formset.prefix }}-group > div.items > div:not(.empty-form)")
            .find("input[name^='" + prefix + "'][name$='" + this + "']")
            .grp_related_fk({lookup_url:"{% url 'grp_related_lookup' %}"});
        });
        $.each(related_lookup_fields_m2m, function() {
            $("#{{ inline_admin_formset.formset.prefix }}-group > div.items > div:not(.empty-form)")
            .find("input[name^='" + prefix + "'][name$='" + this + "']")
            .grp_related_m2m({lookup_url:"{% url 'grp_m2m_lookup' %}"});
        });
        $.each(related_lookup_fields_generic, function() {
            var content_type = this[0],
                object_id = this[1];
            $("#{{ inline_admin_formset.formset.prefix }}-group > div.items > div:not(.empty-form)")
            .find("input[name^='" + prefix + "'][name$='" + this[1] + "']")
            .each(function() {
                var i = $(this).attr("id").match(/-\d+-/);
                if (i) {
                    var ct_id = "#id_" + prefix + i[0] + content_type,
                        obj_id = "#id_" + prefix + i[0] + object_id;
                    $(this).grp_related_generic({content_type:ct_id, object_id:obj_id, lookup_url:"{% url 'grp_related_lookup' %}"});
                }
            });
        });
        $.each(autocomplete_fields_fk, function() {
            $("#{{ inline_admin_formset.formset.prefix }}-group > div.items > div:not(.empty-form)")
            .find("input[name^='" + prefix + "'][name$='" + this + "']")
            .each(function() {
                $(this).grp_autocomplete_fk({
                    lookup_url:"{% url 'grp_related_lookup' %}",
                    autocomplete_lookup_url:"{% url 'grp_autocomplete_lookup' %}"
                });
            });
        });
        $.each(autocomplete_fields_m2m, function() {
            $("#{{ inline_admin_formset.formset.prefix }}-group > div.items > div:not(.empty-form)")
            .find("input[name^='" + prefix + "'][name$='" + this + "']")
            .each(function() {
                $(this).grp_autocomplete_m2m({
                    lookup_url:"{% url 'grp_m2m_lookup' %}",
                    autocomplete_lookup_url:"{% url 'grp_autocomplete_lookup' %}"
                });
            });
        });
        $.each(autocomplete_fields_generic, function() {
            var content_type = this[0],
                object_id = this[1];
            $("#{{ inline_admin_formset.formset.prefix }}-group > div.items > div:not(.empty-form)")
            .find("input[name^='" + prefix + "'][name$='" + this[1] + "']")
            .each(function() {
                var i = $(this).attr("id").match(/-\d+-/);
                if (i) {
                    var ct_id = "#id_" + prefix + i[0] + content_type,
                        obj_id = "#id_" + prefix + i[0] + object_id;
                    $(this).grp_autocomplete_generic({
                        content_type:ct_id,
                        object_id:obj_id,
                        lookup_url:"{% url 'grp_related_lookup' %}",
                        autocomplete_lookup_url:"{% url 'grp_autocomplete_lookup' %}"
                    });
                }
            });
        });
        
        $("#{{ inline_admin_formset.formset.prefix }}-group").grp_inline({
            prefix: "{{ inline_admin_formset.formset.prefix }}",
            onAfterRemoved: function(inline) {},
            onAfterAdded: function(form) {
                grappelli.reinitDateTimeFields(form);
                grappelli.updateSelectFilter(form);
                $.each(related_lookup_fields_fk, function() {
                    form.find("input[name^='" + prefix + "'][name$='" + this + "']")
                    .grp_related_fk({lookup_url:"{% url 'grp_related_lookup' %}"});
                });
                $.each(related_lookup_fields_m2m, function() {
                    form.find("input[name^='" + prefix + "'][name$='" + this + "']")
                    .grp_related_m2m({lookup_url:"{% url 'grp_m2m_lookup' %}"});
                });
                $.each(related_lookup_fields_generic, function() {
                    var content_type = this[0],
                        object_id = this[1];
                    form.find("input[name^='" + prefix + "'][name$='" + this[1] + "']")
                    .each(function() {
                        var i = $(this).attr("id").match(/-\d+-/);
                        if (i) {
                            var ct_id = "#id_" + prefix + i[0] + content_type,
                                obj_id = "#id_" + prefix + i[0] + object_id;
                            $(this).grp_related_generic({content_type:ct_id, object_id:obj_id, lookup_url:"{% url 'grp_related_lookup' %}"});
                        }
                    });
                });
                $.each(autocomplete_fields_fk, function() {
                    form.find("input[name^='" + prefix + "'][name$='" + this + "']")
                    .each(function() {
                        $(this).grp_autocomplete_fk({
                            lookup_url:"{% url 'grp_related_lookup' %}",
                            autocomplete_lookup_url:"{% url 'grp_autocomplete_lookup' %}"
                        });
                    });
                });
                $.each(autocomplete_fields_m2m, function() {
                    form.find("input[name^='" + prefix + "'][name$='" + this + "']")
                    .each(function() {
                        $(this).grp_autocomplete_m2m({
                            lookup_url:"{% url 'grp_m2m_lookup' %}",
                            autocomplete_lookup_url:"{% url 'grp_autocomplete_lookup' %}"
                        });
                    });
                });
                $.each(autocomplete_fields_generic, function() {
                    var content_type = this[0],
                        object_id = this[1];
                    form.find("input[name^='" + prefix + "'][name$='" + this[1] + "']")
                    .each(function() {
                        var i = $(this).attr("id").match(/-\d+-/);
                        if (i) {
                            var ct_id = "#id_" + prefix + i[0] + content_type,
                                obj_id = "#id_" + prefix + i[0] + object_id;
                            $(this).grp_autocomplete_generic({
                                content_type:ct_id,
                                object_id:obj_id,
                                lookup_url:"{% url 'grp_related_lookup' %}",
                                autocomplete_lookup_url:"{% url 'grp_autocomplete_lookup' %}"
                            });
                        }
                    });
                });
                form.grp_collapsible();
                form.find(".grp-collapse").grp_collapsible();
            }
        });
        
        {% if inline_admin_formset.opts.sortable_field_name %}
        $("#{{ inline_admin_formset.formset.prefix }}-group > div.items").sortable({
            handle: "a.drag-handler",
            items: "div.dynamic-form",
            axis: "y",
            appendTo: 'body',
            forceHelperSize: true,
            placeholder: 'ui-sortable-placeholder',
            forcePlaceholderSize: true,
            containment: '#{{ inline_admin_formset.formset.prefix }}-group > div.items',
            tolerance: 'pointer',
            start: function(evt, ui) {
                ui.placeholder.height(ui.item.height() + 12);
            },
        });
        $("#{{ opts.module_name }}_form").bind("submit", function(){
            var sortable_field_name = "{{ inline_admin_formset.opts.sortable_field_name }}";
            var i = 0;
            $("#{{ inline_admin_formset.formset.prefix }}-group").find("div.dynamic-form").each(function(){
                var fields = $(this).find("fieldset :input[value]");
                if (fields.serialize()) {
                    $(this).find("input[name$='"+sortable_field_name+"']").val(i);
                    i++;
                }
            });
        });
        {% endif %}
        
        self.OpeningHoursManager = {
            aDays: ["mon", "tue", "wed", "thu", "fri", "sat", "sun"],
            init: function() {
                $('.apply-to-all').live("click", function() {
                    OpeningHoursManager.applyTimesToAllDays($(this).closest('.grp-module'));
                    return false;
                });
                $('.show_break_times').live("click", function() {
                    OpeningHoursManager.modifyBreakTimes($(this).closest('.grp-module'));
                });
                function apply_closed_on(weekday) {
                    $('.closed_on_' + weekday).live("click", function() {
                        OpeningHoursManager.modifyDay($(this).closest('.grp-module'), weekday);
                    });
                }
                $(OpeningHoursManager.aDays).each(function() {
                    apply_closed_on(this);
                });
                $('.working-hours').each(function() {
                    var $module = $(this).closest('fieldset.grp-module');
                    var bExpanded = false;
                    var aDays = OpeningHoursManager.aDays;
                    var bModifyDefaults = false;
                    $(aDays).each(function() {
                        if ($module.find("[id$=" + this + "_open]").val()) {
                            bModifyDefaults = true;
                        }
                    });
                    if (bModifyDefaults) {
                        $(aDays).each(function() {
                            if (!$module.find("[id$=" + this + "_open]").val()) {
                                $module.find(".closed_on_" + this).attr("checked", true);
                                OpeningHoursManager.modifyDay($module, this);
                            } else if ($module.find("[id$=" + this + "_break_close]").val() && !bExpanded) {
                                $module.find(".show_break_times").attr("checked", true);
                                bExpanded = true;
                            }
                        });
                    }
                    OpeningHoursManager.modifyBreakTimes($module);
                });
            },
            applyTimesToAllDays: function($module) {
                var oDayToCopy = null;
                var aDays = OpeningHoursManager.aDays;
                for (var iPos in aDays) {
                    var oCheckbox = $module.find(".closed_on_" + aDays[iPos]).get(0);
                    if (!oCheckbox.checked) {
                        if (!oDayToCopy) {
                            oDayToCopy = {
                                "open": $module.find("[id$=" + aDays[iPos] + "_open]").val(),
                                "break_close": $module.find("[id$=" + aDays[iPos] + "_break_close]").val(),
                                "break_open": $module.find("[id$=" + aDays[iPos] + "_break_open]").val(),
                                "close": $module.find("[id$=" + aDays[iPos] + "_close]").val()
                            };
                        } else {
                            $module.find("[id$=" + aDays[iPos] + "_open]").val(oDayToCopy.open);
                            $module.find("[id$=" + aDays[iPos] + "_break_close]").val(oDayToCopy.break_close);
                            $module.find("[id$=" + aDays[iPos] + "_break_open]").val(oDayToCopy.break_open);
                            $module.find("[id$=" + aDays[iPos] + "_close]").val(oDayToCopy.close);
                        }
                    }
                }
            },
            modifyDay: function($module, sDay) {
                var oCheckbox = $module.find("[id$=closed_on_" + sDay + "]").get("0");
                $module.find("[id$=" + sDay + "_open").attr("disabled", oCheckbox.checked);
                $module.find("[id$=" + sDay + "_break_close]").attr("disabled", oCheckbox.checked);
                $module.find("[id$=" + sDay + "_break_open").attr("disabled", oCheckbox.checked);
                $module.find("[id$=" + sDay + "_close]").attr("disabled", oCheckbox.checked);
                if (oCheckbox.checked) {
                    $module.find("[id$=" + sDay + "_open]").val("");
                    $module.find("[id$=" + sDay + "_break_close]").val("");
                    $module.find("[id$=" + sDay + "_break_open]").val("");
                    $module.find("[id$=" + sDay + "_close]").val("");
                }
            },
            modifyBreakTimes: function($module) {
                var oCheckbox = $module.find(".show_break_times").get(0);
                if (oCheckbox.checked) {
                    $module.find(".break_start_row").css("display", "table-row");
                    $module.find(".break_end_row").css("display", "table-row");
                } else {
                    $module.find(".break_start_row").css("display", "none");
                    $module.find(".break_end_row").css("display", "none");
                }
            }
        }
        self.OpeningHoursManager.init();
    });
})(django.jQuery);
</script>
