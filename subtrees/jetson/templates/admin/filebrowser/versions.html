{% extends "admin/base_site.html" %}

<!-- LOADING -->
{% load admin_static i18n fb_tags image_mods_tags base_tags static %}
{% load url from future %}

<!-- STYLESHEETS -->
{% block stylesheets %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static "filebrowser/css/filebrowser.css" %}"/>
    {% if query.pop %}
        <style type="text/css">
            #header {
                display: none;
            }
        </style>
    {% endif %}
    <style type="text/css">
        .image-version-th {
            min-width: 100px;
            min-height: 50px;
            padding-right: 35px;
        }

        .image-version {
            display: block;
            color: #59afcc;
            border: 1px solid #D4D4D4;
            background: #eee;
            background: -moz-linear-gradient(top, #eee, #e0e0e0);
            background: -webkit-gradient(linear, left top, left bottom, from(#eee), to(#e0e0e0));
            position: relative;
            max-width: 100%;
        }

        .image-version img {
            max-width: 100%;
        }

        .image-version-tools {
            position: absolute;
            right: -25px;
            top: 0;
        }

        .image-version-tools li {
            margin: 5px;
        }

        a.fb_adjustlink {
            display: block;
            width: 15px;
            height: 15px;
            background: url("{% url 'jetson_media_url' path='filebrowser/img/filebrowser_icon_rename.gif' %}") no-repeat center center;
        }

        a.fb_adjustlink:hover {
            background: url("{% url 'jetson_media_url' path='filebrowser/img/filebrowser_icon_rename_hover.gif' %}") no-repeat center center;
        }

        a.fb_deletelink {
            display: block;
            width: 15px;
            height: 15px;
            background: url("{% url 'jetson_media_url' path='filebrowser/img/filebrowser_icon_delete.gif' %}") no-repeat center center;
        }

        a.fb_deletelink:hover {
            background: url("{% url 'jetson_media_url' path='filebrowser/img/filebrowser_icon_delete_hover.gif' %}") no-repeat center center;
        }

        .hidden {
            display: none;
        }

        .image-version-ungenerated {
            cursor: pointer;
        }
    </style>
{% endblock %}

<!-- JAVASCRIPTS -->
{% block javascripts %}
    {{ block.super }}

    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.0/jquery-ui.min.js"></script>

    {% ifequal query.pop '2' %} <!-- TinyMCE -->
        <script language="javascript"
                type="text/javascript"
                src="{% static "grappelli/tinymce/jscripts/tiny_mce/tiny_mce_popup.js" %}"></script>
        <script language="javascript" type="text/javascript" src="{% static "filebrowser/js/FB_TinyMCE.js" %}"></script>
        <script language="javascript"
                type="text/javascript"
                src="{% url 'jetson_media_url' path='js/admin/FB_TinyMCE_ext.js' %}"></script>
        {% if query.mce_rdomain %}
            <script language="javascript">document.domain = "{{ query.mce_rdomain }}"</script>{% endif %}
    {% endifequal %}
    {% ifequal query.pop '3' %} <!-- CKeditor (former "FCKeditor") -->
        <script language="javascript"
                type="text/javascript"
                src="{% static "filebrowser/js/FB_CKEditor.js" %}"></script>
    {% endifequal %}

    {{ media }}
{% endblock %}

<!-- COLTYPE/BODYCLASS -->
{% block coltype %}colM{% endblock %}
{% block bodyclass %}change-list filebrowser{% if query.pop %} popup{% endif %}{% endblock %}

<!-- BREADCRBUMBS -->
{% block breadcrumbs %}{% include "filebrowser/include/breadcrumbs.html" %}{% endblock %}

<!-- CONTENT -->
{% block content %}
    <div id="content-main">
        <div class="module" id="changelist">
            <div class="changelist-content">

                <table cellspacing="0">
                    <thead>
                    <tr>

                        <!-- Select -->
                        {% ifequal query.pop '2' %}
                            <th></th>{% endifequal %}
                        {% ifequal query.pop '3' %}
                            <th></th>{% endifequal %}

                        <!-- Filename/Dimensions  -->
                        <th>{% trans 'Name' %}</th>

                        <!-- Version -->
                        <th>{% trans 'Image Version' %}</th>

                        <!-- Debug -->
                        {% if settings_var.DEBUG %}
                            <th>{% trans "Debug" %}</th>{% endif %}

                    </tr>
                    </thead>
                    <tbody>
                    {% get_objects versions image_mods.ImageModification 50 as modifications %}
                    {% for mod in modifications %}
                        {% with fileobject|modified_image:mod.sysname as image_version %}
                            {% with fileobject|file_description as f_description %}
                                <tr class="{% cycle 'row1' 'row2' %}">

                                    <!-- Fileselect for RTE/TinyMCE -->
                                    {% if query.pop == '2' %}
                                        <td class="fb_icon">
                                            {% if image_version %}
                                                <button class="grp-button fb_selectlink"
                                                        onclick="FileBrowserDialogue.fileAndDescriptionSubmit({file_path: '{{ UPLOADS_URL }}{{ image_version.path|escapejs }}', title: '{{ f_description.title|escapejs }}', description: '{{ f_description.description|escapejs }}', author: '{{ f_description.author|escapejs }}'});">{% trans "Select" %}</button>
                                            {% endif %}
                                        </td>
                                    {% endif %}

                                    <!-- Fileselect for CKeditor (former "FCKeditor") -->
                                    {% if query.pop == '3' %}
                                        <td class="fb_icon">
                                            {% if image_version %}
                                                <button class="grp-button fb_selectlink"
                                                        onclick="OpenFile(ProtectPath('{{ UPLOADS_URL }}{{ image_version.path|escapejs }}'), '{{ f_description.author|escapejs }}', '{{ f_description.title|escapejs }}');return false;">{% trans "Select" %}</button>
                                            {% endif %}
                                        </td>
                                    {% endif %}

                                    <!-- Filename / Dimensions  -->
                                    <td>
                                        <strong>{{ mod.title }}</strong>
                                        <br/>
                                        {% if mod.crop %}
                                            {% if mod.width %}{% trans "Width" %}: {{ mod.width }}px
                                                <br/>{% endif %}
                                            {% if mod.height %}{% trans "Height" %}: {{ mod.height }}px
                                                <br/>{% endif %}
                                            {% trans "Cropped" %}
                                        {% else %}
                                            {% if mod.width and mod.height %}
                                                {% trans "Max width" %}: {{ mod.width }}px
                                                <br/>
                                                {% trans "Max height" %}: {{ mod.height }}px
                                            {% else %}
                                                {% trans "Width" %}:
                                                {% if mod.width %}{{ mod.width }}px{% else %}*{% endif %}
                                                <br/>
                                                {% trans "Height" %}:
                                                {% if mod.height %}{{ mod.height }}px{% else %}*{% endif %}
                                            {% endif %}
                                        {% endif %}
                                    </td>

                                    <!-- Version -->
                                    <th class="image-version-th">
                                        {% if fileobject|mod_exists:mod.sysname %}
                                            <div class="image-version"
                                                 style="width: {{ image_version.width }}px; height: {{ image_version.height }}px;">
                                                <img src="{{ UPLOADS_URL }}{{ fileobject|modified_path:mod.sysname }}"
                                                     alt=""/>
                                                <ul class="image-version-tools">
                                                    <li>
                                                        <a href="{% url 'fb_adjust_version' %}{% query_string "" "p" %}&amp;sysname={{ mod.sysname }}"
                                                           class="fb_adjustlink"></a>
                                                    </li>
                                                    <li>
                                                        <a href="{% url 'fb_delete_version' %}{% query_string "" "p" %}&amp;sysname={{ mod.sysname }}"
                                                           class="fb_deletelink"></a>
                                                    </li>
                                                </ul>
                                            </div>
                                        {% else %}
                                            <div class="image-version image-version-ungenerated"
                                                 style="width: {{ mod.width|default:100 }}px; height: {{ mod.height|default:100 }}px;"
                                                 data-file_path="{{ fileobject.path }}"
                                                 data-mod_sysname="{{ mod.sysname }}">
                                                <ul class="image-version-tools
                                                        {% if mod.width and mod.height %}{% if mod.width < 100 or mod.height < 100 %} outside{% endif %}{% endif %}">
                                                    <li>
                                                        <a href="{% url 'fb_adjust_version' %}{% query_string "" "p" %}&amp;sysname={{ mod.sysname }}"
                                                           class="fb_adjustlink"></a>
                                                    </li>
                                                </ul>
                                            </div>
                                        {% endif %}
                                    </th>

                                    <!-- Debug -->
                                    {% if settings_var.DEBUG %}
                                        <td>
                                            {% if image_version %}
                                                <strong>Filename</strong> {{ image_version.filename }}
                                                <br/>
                                                <strong>Filetype</strong> {{ image_version.filetype }}
                                                <br/>
                                                <strong>Filesize</strong> {{ image_version.filesize }}
                                                <br/>
                                                <strong>Extension</strong> {{ image_version.extension }}
                                                <br/>
                                                <strong>Date</strong> {{ image_version.date }}
                                                <br/>
                                                <strong>Datetime Object</strong> {{ image_version.datetime }}
                                                <br/>
                                                <br/>

                                                <strong>Full Path</strong> {{ image_version.path_full }}
                                                <br/>
                                                <strong>Relative URL</strong> {{ image_version.url_relative }}
                                                <br/>
                                                <strong>Full URL</strong> {{ image_version.url_full }}
                                                <br/>
                                                <br/>

                                                <strong>URL for FileBrowseField</strong> {{ image_version.url_save }}
                                                <br/>
                                                <strong>Thumbnail URL</strong> {{ image_version.url_thumbnail }}
                                                <br/>
                                                <br/>

                                                <strong>Dimensions</strong> {{ image_version.dimensions }}
                                                <br/>
                                                <strong>Width</strong> {{ image_version.width }}
                                                <br/>
                                                <strong>Height</strong> {{ image_version.height }}
                                                <br/>
                                                <strong>Orientation</strong> {{ image_version.orientation }}
                                            {% else %}
                                                &nbsp;
                                            {% endif %}
                                        </td>
                                    {% endif %}

                                </tr>
                            {% endwith %}
                        {% endwith %}
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        (function ($, undefined) {
            jQuery(document).ajaxSend(function (event, xhr, settings) {
                function getCookie(name) {
                    var cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = jQuery.trim(cookies[i]);
                            // Does this cookie string begin with the name we want?
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }

                function sameOrigin(url) {
                    // url could be relative or scheme relative or absolute
                    var host = document.location.host; // host + port
                    var protocol = document.location.protocol;
                    var sr_origin = '//' + host;
                    var origin = protocol + sr_origin;
                    // Allow absolute or scheme relative URLs to same origin
                    return (url === origin || url.slice(0, origin.length + 1) === origin + '/') ||
                        (url === sr_origin || url.slice(0, sr_origin.length + 1) === sr_origin + '/') ||
                        // or any other URL that isn't scheme relative or absolute i.e relative.
                        !(/^(\/\/|http:|https:).*/.test(url));
                }

                function safeMethod(method) {
                    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                }

                if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                }
            });

            $(function () {
                $('.image-version-ungenerated').one("click", function () {
                    var $image_version = $(this);
                    $image_version.removeClass("image-version-ungenerated");
                    var $button = $image_version.parents('tr').find('.fb_icon button');
                    var file_path = $image_version.attr("data-file_path");
                    var mod_sysname = $image_version.attr("data-mod_sysname");
                    $.post("{% url 'fb_get_version' %}", {
                            file_path: file_path,
                            mod_sysname: mod_sysname
                        }, function (data) {
                            $image_version.append('<img src="{{ UPLOADS_URL }}' + data + '" alt="" />');
                            $button.removeClass("hidden");
                            location.href = location.href;
                        },
                        "text"
                    );
                });
            })
        }(jQuery));
    </script>
{% endblock %}
