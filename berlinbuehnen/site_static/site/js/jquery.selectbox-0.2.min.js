/*!
 * jQuery Selectbox plugin 0.2
 *
 * Copyright 2011-2012, Dimitar Ivanov (http://www.bulgaria-web-developers.com/projects/javascript/selectbox/)
 * Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.
 * 
 * Date: Tue Jul 17 19:58:36 2012 +0300
 */
!function(f,t){
/**
     * Selectbox manager.
     * Use the singleton instance of this class, $.selectbox, to interact with the select box.
     * Settings for (groups of) select boxes are maintained in an instance object,
     * allowing multiple different settings on the same page
     */
function s(){this._state=[],this._defaults={// Global defaults for all the select box instances
classHolder:"sbHolder",classHolderDisabled:"sbHolderDisabled",classSelector:"sbSelector",classOptions:"sbOptions",classGroup:"sbGroup",classSub:"sbSub",classDisabled:"sbDisabled",classToggleOpen:"sbToggleOpen",classToggle:"sbToggle",classFocus:"sbFocus",speed:200,effect:"slide",// "slide" or "fade"
onChange:null,//Define a callback function when the selectbox is changed
onOpen:null,//Define a callback function when the selectbox is open
onClose:null}}var h="selectbox",_=!1,x=!0;f.extend(s.prototype,{
/**
         * Is the first field in a jQuery collection open as a selectbox
         * 
         * @param {Object} target
         * @return {Boolean}
         */
_isOpenSelectbox:function(s){return s?this._getInst(s).isOpen:_;var e},
/**
         * Is the first field in a jQuery collection disabled as a selectbox
         * 
         * @param {HTMLElement} target
         * @return {Boolean}
         */
_isDisabledSelectbox:function(s){return s?this._getInst(s).isDisabled:_;var e},
/**
         * Attach the select box to a jQuery selection.
         * 
         * @param {HTMLElement} target
         * @param {Object} settings
         */
_attachSelectbox:function(l,s){function t(){var s,e,t=this.attr("id").split("_")[1];for(s in d._state)s!==t&&d._state.hasOwnProperty(s)&&(e=f("select[sb='"+s+"']")[0])&&d._closeSelectbox(e)}function a(s,e){var a=!(!e||!e.sub),n=!(!e||!e.disabled);s.each(function(s){var e=f(this),t=f("<li>"),i;e.is(":selected")&&(c.text(e.text()),p=x),s===g-1&&t.addClass("last"),e.is(":disabled")||n?(i=f("<span>",{text:e.text()}).addClass(o.settings.classDisabled),a&&i.addClass(o.settings.classSub)):(i=f("<a>",{href:"#"+e.val(),rel:e.val()}).text(e.text()).bind("click.sb",function(s){s&&s.preventDefault&&s.preventDefault();var e=r,t=f(this),i=e.attr("id").split("_")[1];d._changeSelectbox(l,t.attr("rel"),t.text()),d._closeSelectbox(l)}).bind("mouseover.sb",function(){var s=f(this);s.parent().siblings().find("a").removeClass(o.settings.classFocus),s.addClass(o.settings.classFocus)}).bind("mouseout.sb",function(){f(this).removeClass(o.settings.classFocus)}),a&&i.addClass(o.settings.classSub),e.is(":selected")&&i.addClass(o.settings.classFocus)),i.appendTo(t),t.appendTo(u)})}if(this._getInst(l))return _;var e=f(l),d=this,o=d._newInst(e),i,c,r,u,p=_,n=e.find("optgroup"),b=e.find("option"),g=b.length;e.attr("sb",o.uid),f.extend(o.settings,d._defaults,s),d._state[o.uid]=_,e.hide(),i=f("<div>",{id:"sbHolder_"+o.uid,class:o.settings.classHolder,tabindex:e.attr("tabindex")}),c=f("<a>",{id:"sbSelector_"+o.uid,href:"#",class:o.settings.classSelector,click:function(s){s.preventDefault(),t.apply(f(this),[]);var e=f(this).attr("id").split("_")[1];d._state[e]?d._closeSelectbox(l):d._openSelectbox(l)}}),(r=f("<a>",{id:"sbToggle_"+o.uid,href:"#",class:o.settings.classToggle,click:function(s){s.preventDefault(),t.apply(f(this),[]);var e=f(this).attr("id").split("_")[1];d._state[e]?d._closeSelectbox(l):d._openSelectbox(l)}})).appendTo(i),u=f("<ul>",{id:"sbOptions_"+o.uid,class:o.settings.classOptions,css:{display:"none"}}),e.children().each(function(s){var e=f(this),t,i={};e.is("option")?a(e):e.is("optgroup")&&(t=f("<li>"),f("<span>",{text:e.attr("label")}).addClass(o.settings.classGroup).appendTo(t),t.appendTo(u),e.is(":disabled")&&(i.disabled=!0),i.sub=!0,a(e.find("option"),i))}),p||c.text(b.first().text()),f.data(l,h,o),i.data("uid",o.uid).bind("keydown.sb",function(s){var e=s.charCode?s.charCode:s.keyCode?s.keyCode:0,t=f(this),i=t.data("uid"),a=t.siblings("select[sb='"+i+"']").data(h),n=t.siblings(["select[sb='",i,"']"].join("")).get(0),l=t.find("ul").find("a."+a.settings.classFocus);switch(e){case 37://Arrow Left
case 38:var o;//Arrow Up
if(0<l.length)f("a",t).removeClass(a.settings.classFocus),0<(o=l.parent().prevAll("li:has(a)").eq(0).find("a")).length&&(o.addClass(a.settings.classFocus).focus(),f("#sbSelector_"+i).text(o.text()));break;case 39://Arrow Right
case 40://Arrow Down
var o;f("a",t).removeClass(a.settings.classFocus),0<(o=0<l.length?l.parent().nextAll("li:has(a)").eq(0).find("a"):t.find("ul").find("a").eq(0)).length&&(o.addClass(a.settings.classFocus).focus(),f("#sbSelector_"+i).text(o.text()));break;case 13://Enter
0<l.length&&d._changeSelectbox(n,l.attr("rel"),l.text()),d._closeSelectbox(n);break;case 9:var a;//Tab
if(n)(a=d._getInst(n))&&(0<l.length&&d._changeSelectbox(n,l.attr("rel"),l.text()),d._closeSelectbox(n));var c=parseInt(t.attr("tabindex"),10);s.shiftKey?c--:c++,f("*[tabindex='"+c+"']").focus();break;case 27://Escape
d._closeSelectbox(n);break}return s.stopPropagation(),!1}).delegate("a","mouseover",function(s){f(this).addClass(o.settings.classFocus)}).delegate("a","mouseout",function(s){f(this).removeClass(o.settings.classFocus)}),c.appendTo(i),u.appendTo(i),i.insertAfter(e),f("html").on("mousedown",function(s){s.stopPropagation(),f("select").selectbox("close")}),f([".",o.settings.classHolder,", .",o.settings.classSelector].join("")).mousedown(function(s){s.stopPropagation()})},
/**
         * Remove the selectbox functionality completely. This will return the element back to its pre-init state.
         * 
         * @param {HTMLElement} target
         */
_detachSelectbox:function(s){var e=this._getInst(s);if(!e)return _;f("#sbHolder_"+e.uid).remove(),f.data(s,h,null),f(s).show()},
/**
         * Change selected attribute of the selectbox.
         * 
         * @param {HTMLElement} target
         * @param {String} value
         * @param {String} text
         */
_changeSelectbox:function(s,e,t){var i,a=this._getInst(s);a&&(i=this._get(a,"onChange"),f("#sbSelector_"+a.uid).text(t)),e=e.replace(/\'/g,"\\'"),f(s).find("option[value='"+e+"']").attr("selected",x),a&&i?i.apply(a.input?a.input[0]:null,[e,a]):a&&a.input&&a.input.trigger("change")},
/**
         * Enable the selectbox.
         * 
         * @param {HTMLElement} target
         */
_enableSelectbox:function(s){var e=this._getInst(s);if(!e||!e.isDisabled)return _;f("#sbHolder_"+e.uid).removeClass(e.settings.classHolderDisabled),e.isDisabled=_,f.data(s,h,e)},
/**
         * Disable the selectbox.
         * 
         * @param {HTMLElement} target
         */
_disableSelectbox:function(s){var e=this._getInst(s);if(!e||e.isDisabled)return _;f("#sbHolder_"+e.uid).addClass(e.settings.classHolderDisabled),e.isDisabled=x,f.data(s,h,e)},
/**
         * Get or set any selectbox option. If no value is specified, will act as a getter.
         * 
         * @param {HTMLElement} target
         * @param {String} name
         * @param {Object} value
         */
_optionSelectbox:function(s,e,t){var i=this._getInst(s);if(!i)return _;
//TODO check name
i[e]=t,f.data(s,h,i)},
/**
         * Call up attached selectbox
         * 
         * @param {HTMLElement} target
         */
_openSelectbox:function(s){var e=this._getInst(s);
//if (!inst || this._state[inst.uid] || inst.isDisabled) {
if(e&&!e.isOpen&&!e.isDisabled){var t=f("#sbOptions_"+e.uid),i=parseInt(f(window).height(),10),a=f("#sbHolder_"+e.uid).offset(),n=f(window).scrollTop(),l=t.prev().height(),o=i-(a.top-n)-l/2,c=this._get(e,"onOpen");t.css({top:l+"px",maxHeight:o-l+"px"}),"fade"===e.settings.effect?t.fadeIn(e.settings.speed):t.slideDown(e.settings.speed),f("#sbToggle_"+e.uid).addClass(e.settings.classToggleOpen),this._state[e.uid]=x,e.isOpen=x,c&&c.apply(e.input?e.input[0]:null,[e]),f.data(s,h,e)}},
/**
         * Close opened selectbox
         * 
         * @param {HTMLElement} target
         */
_closeSelectbox:function(s){var e=this._getInst(s);
//if (!inst || !this._state[inst.uid]) {
if(e&&e.isOpen){var t=this._get(e,"onClose");"fade"===e.settings.effect?f("#sbOptions_"+e.uid).fadeOut(e.settings.speed):f("#sbOptions_"+e.uid).slideUp(e.settings.speed),f("#sbToggle_"+e.uid).removeClass(e.settings.classToggleOpen),this._state[e.uid]=_,e.isOpen=_,t&&t.apply(e.input?e.input[0]:null,[e]),f.data(s,h,e)}},
/**
         * Create a new instance object
         * 
         * @param {HTMLElement} target
         * @return {Object}
         */
_newInst:function(s){var e;return{id:s[0].id.replace(/([^A-Za-z0-9_-])/g,"\\\\$1"),input:s,uid:Math.floor(99999999*Math.random()),isOpen:_,isDisabled:_,settings:{}}},
/**
         * Retrieve the instance data for the target control.
         * 
         * @param {HTMLElement} target
         * @return {Object} - the associated instance data
         * @throws error if a jQuery problem getting data
         */
_getInst:function(s){try{return f.data(s,h)}catch(s){throw"Missing instance data for this selectbox"}},
/**
         * Get a setting value, defaulting if necessary
         * 
         * @param {Object} inst
         * @param {String} name
         * @return {Mixed}
         */
_get:function(s,e){return s.settings[e]!==t?s.settings[e]:this._defaults[e]}}),
/**
     * Invoke the selectbox functionality.
     * 
     * @param {Object|String} options
     * @return {Object}
     */
f.fn.selectbox=function(s,e){var t=Array.prototype.slice.call(arguments,1);return"string"==typeof s&&"isDisabled"==s?f.selectbox["_"+s+"Selectbox"].apply(f.selectbox,[this[0]].concat(t)):"option"==s&&2==arguments.length&&"string"==typeof e?f.selectbox["_"+s+"Selectbox"].apply(f.selectbox,[this[0]].concat(t)):this.each(function(){"string"==typeof s?f.selectbox["_"+s+"Selectbox"].apply(f.selectbox,[this].concat(t)):f.selectbox._attachSelectbox(this,s)})},f.selectbox=new s,// singleton instance
f.selectbox.version="0.2"}(jQuery);