{% extends "education/projects/forms/base.html" %}
{% load crispy_forms_tags i18n sekizai_tags %}

{% block stylesheet %}
    {{ block.super }}
    <link href="{{ STATIC_URL }}site/js/autocomplete_1.0/jquery.autocomplete.css" rel="stylesheet" />
{% endblock %}

{% block js %}
    {{ block.super }}
    <script src="{{ STATIC_URL }}site/js/autocomplete_1.0/jquery.bgiframe.min.js"></script>
    <script src="{{ STATIC_URL }}site/js/autocomplete_1.0/jquery.autocomplete.js"></script>
    <script src="{{ STATIC_URL }}site/js/autocomplete.js"></script>
{% endblock %}

{% block multistep_form %}
    {% crispy form %}
    <script src="https://maps.google.com/maps/api/js?language={{ LANGUAGE_CODE }}&amp;region=DE&amp;key={{ GOOGLE_API_KEY }}"></script>
    <script src="{{ STATIC_URL }}site/js/locating.min.js"></script>
    <script src="{{ STATIC_URL }}site/js/checkbox-tree.js"></script>
    {% now "u" as microseconds %}
    <script nonce="{{ microseconds }}">
        function reinit_widgets() {
            $('[rel=tooltip]').tooltip();
            $('[id^="id_social"][id$="channel_type"]').autocomplete(['Google+', 'Twitter', 'Facebook', 'LinkedIn', 'XING', 'Instagram', 'Soundcloud', 'Youtube', 'Pinterest']);
            $('select:visible').not('[name*="__prefix__"]').selectbox();
        
            $('.dateinput').not('.done').datepicker({
                format: 'yyyy-mm-dd',
                weekStart: 1
            }).addClass('done');
            $('.timeinput').not('.done').timepicker({
                str_hours: '{% trans "Hours" %}',
                str_minutes: '{% trans "Minutes" %}',
                str_confirm: '{% trans "Confirm" %}',
                str_close: '{% trans "Close" %}'
            }).addClass('done');
        }

        function set_index_for_fields($formset_form, index) {
            $formset_form.find(':input').each(function() {
                var $field = $(this);
                if ($field.attr("id")) {
                    $field.attr(
                        "id",
                        $field.attr("id").replace(/-__prefix__-/, "-" + index + "-")
                    );
                }
                if ($field.attr("name")) {
                    $field.attr(
                        "name",
                        $field.attr("name").replace(/-__prefix__-/, "-" + index + "-")
                    );
                }
            });
            $formset_form.find('label').each(function() {
                var $field = $(this);
                if ($field.attr("for")) {
                    $field.attr(
                        "for",
                        $field.attr("for").replace(/-__prefix__-/, "-" + index + "-")
                    );
                }
            });
            $formset_form.find('div').each(function() {
                var $field = $(this);
                if ($field.attr("id")) {
                    $field.attr(
                        "id",
                        $field.attr("id").replace(/-__prefix__-/, "-" + index + "-")
                    );
                }
            });
        }

        $(function() {
        
            var $new_form = $('#times_empty_form');
            $('.dateinput', $new_form).addClass('done');
            $('.timeinput', $new_form).addClass('done');
            reinit_widgets();
        
            $(
                '<a class="add btn btn-primary" id="add_time" href="#">{% trans "Add date and time" %}</a>'
            ).insertAfter('#times').click(function() {
                var $total_forms = $('#id_times-TOTAL_FORMS');
                var $new_form = $('#times_empty_form').clone(true).attr("id", null).show();
                $('.dateinput', $new_form).removeClass('done');
                $('.timeinput', $new_form).removeClass('done');
                set_index_for_fields($new_form, parseInt($total_forms.val(), 10));
                $('#times').append($new_form);
                $total_forms.val(parseInt($total_forms.val(), 10) + 1);
                reinit_widgets();
                return false;
            });

            $('.formset-form').each(function() {
                var $formset_form = $(this);
                $formset_form.find('input:checkbox[id$=DELETE]').each(function() {
                    var $checkbox = $(this);
                    var $deleteLink = $(
                        '<span class="input-group-btn delete-time"><button class="delete btn btn-lg btn-info btn-icon" data-toggle="tooltip" data-placement="top" data-original-title="{% trans "Delete" %}"><span class="icon icon-remove"></span><span class="sr-only">{% trans "Remove" %}</span></button></span>'
                    );
                    $checkbox.closest('.formset-form').append($deleteLink);
                    $checkbox.closest('.form-group').hide();
                });
            });
            $('.delete').on('click', function() {
                var $formset_form = $(this).closest('.formset-form');
                var $checkbox = $formset_form.find('input:checkbox[id$=DELETE]');
                $checkbox.attr("checked", "checked");
                $formset_form.hide();
                return false;
            });
            
            // Initial state
            var $total_forms = $('#id_times-TOTAL_FORMS');
            if ($total_forms.val() == "0") {
                $('#add_time').click();
            }

        });
    </script>
    {% add_data "script_nonces" " 'nonce-"|add:microseconds|add:"'" %}
{% endblock %}
