{% extends "base.html" %}
{% load i18n base_tags image_modifications tagging_tags favorites_tags sekizai_tags auth_extended %}

{% block js %}
    {{ block.super }}
    <script type="text/javascript" src="{{ STATIC_URL }}site/js/share.min.js" defer="defer"></script>
    {% include "utils/favorites_scripts.html" %}
{% endblock %}

{% block title %}{% trans "Favorites" %}{% endblock %}
{% block open_graph %}
    <meta property="og:url" content="{{ request.build_absolute_uri  }}" />
    {% comment %}
    <meta property="og:image" content="http://www.lange-nacht-der-museen.de/media/opengraph/fahren_big.png" />
    {% endcomment %}
    <meta property="og:type" content="article" />
    <meta property="og:title" content="{{ list_options.title|default:_("Favorites") }}" />
    <meta property="og:site_name" content="{{ list_options.title|default:_("Favorites") }}" />
    {% if list_options.description_striped %}<meta property="og:description" content="{{ list_options.description_striped|urlize|striptags }}" />{% endif %}
{% endblock %}

{% block content %}
    <div class="content">
        <div class="container">
            <div class="row">
                <div class="box col-xs-12">
                    <div class="personalize-wrapper">
                        <h1>{{ list_options.title|default:_("Favorites") }}</h1>
                        {% if list_options.description %}<div class="personalize-copy">{{ list_options.description|urlize|linebreaks }}</div>{% endif %}
                    </div>
                    {% if not favorites.locations and not favorites.productions and not favorites.festivals and not favorites.projects %}
                        <h3>{% trans "You didn't favor any objects." %}</h3>
                    {% else %}
                        <div class="sozial-panel pull-right">
                            {% if request.user.is_authenticated %}
                                {% if request.user.id == user_id or request.user.is_staff %}
                                    <button id="change_favorites_list" class="sozial-button fawesome edit" data-href="{{ request.path }}change/" data-toggle="tooltip" data-placement="top" data-original-title="{% trans "Edit My Tour description" %}">
                                        <span class="sr-only">{% trans "Edit my tour description" %}</span>
                                    </button>
                                {% endif %}
                                <button id="send_user_favorites_by_email" class="sozial-button fawesome email" data-href="{{ request.path }}email/" data-toggle="tooltip" data-placement="top" data-original-title="{% trans "Email list to a friend" %}">
                                    <span class="sr-only">{% trans "Email this list to a friend" %}</span>
                                </button>
                            {% endif %}
                            <button class="sozial-button fawesome twitter share-twitter" data-url="{{ website_url|slice:":-1" }}{{ request.path }}" data-text="{% trans "My Tour at the long night of museums" %}" data-toggle="tooltip" data-placement="top" data-original-title="{% trans "Tweet list" %}">
                                <span class="sr-only">{% trans "Tweet this list" %}</span>
                            </button>
                            <button class="sozial-button fawesome facebook share-facebook" data-url="{{ website_url|slice:":-1" }}{{ request.path }}" data-text="{% trans "My Tour at the long night of museums" %}" data-toggle="tooltip" data-placement="top" data-original-title="{% trans "Share list on Facebook" %}">
                                <span class="sr-only">{% trans "Share this list on Facebook" %}</span>
                            </button>
                            {% comment %}
                            <a class="sozial-button icon icon-location" href="{{ request.path }}map/{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" data-toggle="tooltip" data-placement="left" data-original-title="{% trans "Show list on map" %}">
                                <span class="sr-only">{% trans "Show this list on map" %}</span>
                            </a>
                            {% endcomment %}
                        </div>
                    {% endif %}
                </div>
                <br /><br /><br /><br />
                {% if favorites.locations %}
                    <div class="box col-xs-12">
                        <h2>{% trans "Theaters" %}</h2>
                        <div class="grid location-grid grid-autoload row">
                            {% for location in favorites.locations %}
                                <a class="grid-item col-xs-12 col-sm-6 col-md-4 col-lg-3" href="{{ location.get_url_path }}">

                                    <!-- image -->
                                    <span class="grid-item-image img">
                                        {% comment %}{% if location.logo %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_location_grid.png" data-original="{{ MEDIA_URL }}{{ location.logo|modified_path:"detail_image" }}{% if_has_perm "location.change_location" location %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ location.title|escape }}" />{% endcomment %}
                                        {% if location.first_image %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_location_grid.png" data-original="{{ MEDIA_URL }}{{ location.first_image.path|modified_path:"detail_image" }}{% if_has_perm "location.change_location" location %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ event.production.title|escape }}" />
                                        {% elif location.image_set.exists %}
                                            {% with location.image_set.all|first as image %}
                                                <img src="{{ STATIC_URL }}site/img/placeholder_location_grid.png" data-original="{{ MEDIA_URL }}{{ image.path|modified_path:"detail_image" }}{% if_has_perm "location.change_location" location %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ location.title|escape }}" />
                                            {% endwith %}
                                        {% else %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_location_grid.png" />
                                        {% endif %}
                                    </span>

                                    {% if location.title %}<h2>{{ location.title }}</h2>{% endif %}
                                    {% if location.subtitle %}<h3>{{ location.subtitle }}</h3>{% endif %}
                                    {% if location.teaser %}
                                        <div class="copy">{{ location.get_rendered_teaser }}</div>
                                    {% elif location.description %}
                                        <div class="copy">{{ location.get_rendered_description|truncatewords:20 }}</div>
                                    {% endif %}

                                </a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                {% if favorites.productions %}
                    <div class="box col-xs-12">
                        <h2>{% trans "Productions" %}</h2>
                        <div class="grid location-grid grid-autoload row">
                            {% for production in favorites.productions %}
                                <a class="grid-item col-xs-12 col-sm-6 col-md-4 col-lg-3" href="{{ production.get_url_path }}">

                                    <!-- image -->
                                    <span class="grid-item-image img">
                                        {% comment %}{% if production.logo %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_production_grid.png" data-original="{{ MEDIA_URL }}{{ production.logo|modified_path:"detail_image" }}{% if_has_perm "production.change_production" production %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ production.title|escape }}" />{% endcomment %}
                                        {% if production.first_image %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_production_grid.png" data-original="{{ MEDIA_URL }}{{ production.first_image.path|modified_path:"detail_image" }}{% if_has_perm "production.change_production" production %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ event.production.title|escape }}" />
                                        {% elif production.image_set.exists %}
                                            {% with production.image_set.all|first as image %}
                                                <img src="{{ STATIC_URL }}site/img/placeholder_production_grid.png" data-original="{{ MEDIA_URL }}{{ image.path|modified_path:"detail_image" }}{% if_has_perm "production.change_production" production %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ production.title|escape }}" />
                                            {% endwith %}
                                        {% else %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_production_grid.png" />
                                        {% endif %}
                                    </span>

                                    {% if production.title %}<h2>{{ production.title }}</h2>{% endif %}
                                    {% if production.subtitle %}<h3>{{ production.subtitle }}</h3>{% endif %}
                                    {% if production.teaser %}
                                        <div class="copy">{{ production.get_rendered_teaser }}</div>
                                    {% elif production.description %}
                                        <div class="copy">{{ production.get_rendered_description|truncatewords:20 }}</div>
                                    {% endif %}

                                </a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                {% if favorites.festivals %}
                    <div class="box col-xs-12">
                        <h2>{% trans "Festivals" %}</h2>
                        <div class="grid location-grid grid-autoload row">
                            {% for festival in favorites.festivals %}
                                <a class="grid-item col-xs-12 col-sm-6 col-md-4 col-lg-3" href="{{ festival.get_url_path }}">

                                    <!-- image -->
                                    <span class="grid-item-image img">
                                        {% comment %}{% if festival.logo %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_festival_grid.png" data-original="{{ MEDIA_URL }}{{ festival.logo|modified_path:"detail_image" }}{% if_has_perm "festival.change_festival" festival %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ festival.title|escape }}" />{% endcomment %}
                                        {% if festival.first_image %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_festival_grid.png" data-original="{{ MEDIA_URL }}{{ festival.first_image.path|modified_path:"detail_image" }}{% if_has_perm "festival.change_festival" festival %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ event.festival.title|escape }}" />
                                        {% elif festival.image_set.exists %}
                                            {% with festival.image_set.all|first as image %}
                                                <img src="{{ STATIC_URL }}site/img/placeholder_festival_grid.png" data-original="{{ MEDIA_URL }}{{ image.path|modified_path:"detail_image" }}{% if_has_perm "festival.change_festival" festival %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ festival.title|escape }}" />
                                            {% endwith %}
                                        {% else %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_festival_grid.png" />
                                        {% endif %}
                                    </span>

                                    {% if festival.title %}<h2>{{ festival.title }}</h2>{% endif %}
                                    {% if festival.subtitle %}<h3>{{ festival.subtitle }}</h3>{% endif %}
                                    {% if festival.teaser %}
                                        <div class="copy">{{ festival.get_rendered_teaser }}</div>
                                    {% elif festival.description %}
                                        <div class="copy">{{ festival.get_rendered_description|truncatewords:20 }}</div>
                                    {% endif %}

                                </a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                {% if favorites.projects %}
                    <div class="box col-xs-12">
                        <h2>{% trans "Educational Projects" %}</h2>
                        <div class="grid location-grid grid-autoload row">
                            {% for project in favorites.projects %}
                                <a class="grid-item col-xs-12 col-sm-6 col-md-4 col-lg-3" href="{{ project.get_url_path }}">

                                    <!-- image -->
                                    <span class="grid-item-image img">
                                        {% comment %}{% if project.logo %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_project_grid.png" data-original="{{ MEDIA_URL }}{{ project.logo|modified_path:"detail_image" }}{% if_has_perm "project.change_project" project %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ project.title|escape }}" />{% endcomment %}
                                        {% if project.first_image %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_project_grid.png" data-original="{{ MEDIA_URL }}{{ project.first_image.path|modified_path:"detail_image" }}{% if_has_perm "project.change_project" project %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ event.project.title|escape }}" />
                                        {% elif project.image_set.exists %}
                                            {% with project.image_set.all|first as image %}
                                                <img src="{{ STATIC_URL }}site/img/placeholder_project_grid.png" data-original="{{ MEDIA_URL }}{{ image.path|modified_path:"detail_image" }}{% if_has_perm "project.change_project" project %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ project.title|escape }}" />
                                            {% endwith %}
                                        {% else %}
                                            <img src="{{ STATIC_URL }}site/img/placeholder_project_grid.png" />
                                        {% endif %}
                                    </span>

                                    {% if project.title %}<h2>{{ project.title }}</h2>{% endif %}
                                    {% if project.subtitle %}<h3>{{ project.subtitle }}</h3>{% endif %}
                                    {% if project.teaser %}
                                        <div class="copy">{{ project.get_rendered_teaser }}</div>
                                    {% elif project.description %}
                                        <div class="copy">{{ project.get_rendered_description|truncatewords:20 }}</div>
                                    {% endif %}

                                </a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if facets.selected.latitude and facets.selected.longitude %}
        {% addtoblock "js" %}
            <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&v=3&libraries=geometry"></script>
            <script>
                $(function() {
                    var visitor_position = new google.maps.LatLng({{ facets.selected.latitude|stringformat:"f" }}, {{ facets.selected.longitude|stringformat:"f" }});
                    $('.overview-item').each(function(index, el) {
                        var object_position = new google.maps.LatLng(parseFloat($(el).data('latitude')), parseFloat($(el).data('longitude')));
                        var distance_in_meters = google.maps.geometry.spherical.computeDistanceBetween(visitor_position, object_position);
                        var humanized_distance;
                        if (distance_in_meters >= 1000) {
                            humanized_distance = (distance_in_meters/1000).toFixed(1) + ' km';
                        } else {
                            humanized_distance = distance_in_meters.toFixed(0) + ' m';
                        }
                        $(el).find('.distance').html(humanized_distance);
                    });
                })
            </script>
        {% endaddtoblock %}
    {% endif %}
    {% addtoblock "js" %}
        <script>
            $('#change_favorites_list').on('click', function() {
                window.open($(this).data('href'), '_blank', 'width=600,height=750');
            });
            $('#send_user_favorites_by_email').on('click', function() {
                window.open($(this).data('href'), '_blank', 'width=600,height=750');
            });
        </script>
    {% endaddtoblock %}
{% endblock %}