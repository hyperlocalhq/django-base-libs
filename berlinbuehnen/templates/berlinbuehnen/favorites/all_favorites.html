{% extends "base.html" %}
{% load i18n base_tags image_modifications tagging_tags production_tags favorites auth_extended %}

{% block js %}
{{ block.super }}
<script type="text/javascript" src="{{ STATIC_URL }}site/js/favorites.min.js" defer="defer"></script>
<script type="text/javascript" src="{{ STATIC_URL }}site/js/isotope/isotope.pkgd.min.js"></script>
<script type="text/javascript">
    $(function() {
        $('.favorite').click(function(e) {
            e.preventDefault();
            var $badge = $(this).closest('.container').find('h3:first .badge');
            $badge.text(parseInt($badge.text()) - 1);
            $(this).closest('.list-item').remove();
            $('#favorites .list').isotope('layout');
        });
    });
    
    $( document ).ready(function() {
    
        var $container = $('#favorites .list');
        var $buttons = $('#filters label');
        
        $container.isotope({
            layoutMode: 'masonry',
            itemSelector: '.list-item'
        });
        
        var init = function() {
        
            $('.list-item', $container).each(function() {
                
                var $this = $(this);
                var $links = $('a', $this);
            
                if ($links.length == 2) {
                
                    var $img =    $($links[0]);
                    var $content = $($links[1]);
                
                    $this.css("height", "auto");
                    $("img", $img).css("visibility", "visible");
                    $content.removeClass('item-hidden');
                    $content.css("top", "0px");
                    $content.css("height", "auto");
                    $content.css("display", "block");
                
                    $this.off();
                    
                    if ($img.css("display") == "block") {
                    
                        var img_height = $("img", $img).height();
                     
                        $content.addClass('item-hidden');
                        $content.css("top", "-"+img_height+"px");
                        $this.height(img_height);
                     
                        if (img_height > $content.height() + 70) $content.height(img_height - 70);
                        $content.css("display", "none");
                    
                        $this.mouseenter(onMouseEnter);
                        $this.mouseleave(onMouseLeave);
                    }
                }
            });        
            
            $container.isotope('layout');
        }
        
        var onMouseEnter = function(event) {
        
            var $this = $(this);
            var $links = $('a', $this);

            if ($links.length == 2) {

                 var $img = $("img", $($links[0]));
                 var $content = $($links[1]);

                 $img.css("visibility", "hidden");
                 $content.css("display", "block");

                 $this.height($content.height());
            }

            $this.css("z-index", 100);
        }
        
        var onMouseLeave = function(event) {
                
            var $this = $(this);
            var $links = $('a', $this);

            if ($links.length == 2) {

                 var $img = $("img", $($links[0]));
                 var $content = $($links[1]);

                 $img.css("visibility", "visible");
                 $content.css("display", "none");

                 $this.height($img.height());
            }

            $this.css("z-index", "inherit");
        }
        
        var onFilter = function(event) {
            
            var $button = $(this);
            var active = !$button.hasClass("active");
        
            $buttons.each(function() {
                $(this).removeClass("active");
            });
            
            if (active) {
                $container.isotope({ filter: $button.attr('data-filter') });
            } else {
                $container.isotope({ filter: '*' });
                event.stopImmediatePropagation();
            }
            
        }
        
        
        $( window ).resize(init);
        $buttons.click(onFilter);
        
{#        $container.imagesLoaded( function() {#}
{#            init();#}
{#        });#}
        
    });
</script>

{% endblock %}

{% block title %}{% trans "Favorites" %}{% endblock %}

{% block content %}
<div id="favorites">
    <div class="content">
        <div class="container">
            {% if object_list %}
                <h3>{% trans "Favorites" %} <span class="badge">{{ object_list.count }}</span></h3>
                <div id="filters">
                    <div class="btn-group" data-toggle="buttons">
                        <label type="button" class="btn btn-info btn-sm" data-filter=".location">{% trans "Theaters" %}</label>
                        <label type="button" class="btn btn-info btn-sm" data-filter=".event">{% trans "Events" %}</label>
                    </div>
                </div>
                <div class="list row row-md">
                    {% for favorite in object_list %}
                        {% with item=favorite.content_object type=favorite.content_type.model.lower %}
                            {% if type == "location" %}
                                {% with location=item %}
                                    <div class="list-item col-xs-12 location">
                                        <div class="row">

                                            <!-- list item head (date and image) -->
                                            <div class="list-item-head col-xs-12 col-sm-5 col-md-4 col-lg-3">
                                                <div class="row">

                                                    <!-- image -->
                                                    <div class="list-item-head-image img col-xs-1 col-sm-12">
                                                        {% comment %}{% if location.logo %}
                                                            <img src="{{ MEDIA_URL }}{{ location.logo|modified_path:"list_logo" }}{% if_has_perm "location.change_location" location %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ location.title|escape }}" />{% endcomment %}
                                                        {% if location.first_image %}
                                                            <img src="{{ MEDIA_URL }}{{ location.first_image.path|modified_path:"list_image" }}{% if_has_perm "location.change_location" location %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ event.production.title|escape }}" />
                                                        {% elif location.image_set.exists %}
                                                            {% with location.image_set.all|first as image %}
                                                                <img src="{{ MEDIA_URL }}{{ image.path|modified_path:"list_image" }}{% if_has_perm "location.change_location" location %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ location.title|escape }}" />
                                                            {% endwith %}
                                                        {% else %}
                                                            <img src="{{ STATIC_URL }}site/img/placeholder_location.png" />
                                                        {% endif %}
                                                    </div>

                                                </div>
                                            </div>

                                            <!-- list item body -->
                                            <div class="list-item-body col-xs-12 col-sm-7 col-md-8 col-lg-9">
                                                <a class="list-item-link" href="{{ location.get_url_path }}">
                                                    {% if location.title %}<h2>{{ location.title }}</h2>{% endif %}

                                                    {% if request.user.is_authenticated %}
                                                        {% adding2favorites for location using "favorites/includes/favorite_detail.html" %}
                                                    {% endif %}

                                                    {% if location.subtitle %}<h3>{{ location.subtitle }}</h3>{% endif %}
                                                    {% if location.description %}<div class="copy">{{ location.get_rendered_description }}</div>{% endif %}
                                                </a>
                                            </div>

                                        </div>
                                    </div>
                                {% endwith %}
                            {% endif %}
                            {% if type == "event" %}
                                {% with event=item %}
                                    <div class="list-item col-xs-12 event">
                                        <div class="row">

                                            <!-- list item head (date and image) -->
                                            <div class="list-item-head col-xs-12 col-sm-5 col-md-4 col-lg-3">
                                                <div class="row">

                                                    <!-- date -->
                                                    <div class="list-item-head-date col-xs-12 col-sm-4">
                                                        <div class="row">
                                                            <div class="list-item-head-date-day col-xs-3 col-sm-12">
                                                                {{ event.start_date|date:"D" }}
                                                            </div>
                                                            <div class="list-item-head-date-month col-xs-3 col-sm-12">
                                                                <span class="hidden-xs">{{ event.start_date|date:"j. F" }}</span>
                                                                <span class="visible-xs">{{ event.start_date|date:"j. M" }}</span>
                                                            </div>
                                                            <div class="list-item-head-date-type col-xs-3 col-sm-12">
                                                                {% if event.production.get_categories %}
                                                                    {{ event.production.get_categories.0.title }}
                                                                {% endif %}
                                                            </div>
                                                            <div class="list-item-head-date-time col-xs-3 col-sm-12">
                                                                {{ event.start_time|time:"H:i" }}
                                                            </div>
                                                            <div class="list-item-head-date-icons col-xs-3 col-sm-12">
                                                                {% add_to_calender event=event %}
                                                                {% if event.ev_or_prod_tickets_website %}
                                                                    <a class="fawesome tickets" href="{{ event.ev_or_prod_tickets_website }}" target="_blank"></a>
                                                                {% endif %}
                                                                {% if request.user.is_authenticated %}
                                                                    {% adding2favorites for event using "favorites/includes/favorite_detail.html" %}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- image -->
                                                    <div class="list-item-head-image img hidden-xs col-sm-8">
                                                        {% if event.first_image %}
                                                            <img src="{{ MEDIA_URL }}{{ event.first_image.path|modified_path:"list_image" }}{% if_has_perm "events.change_event" event %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ event.production.title|escape }}" />
                                                        {% elif event.ev_or_prod_images %}
                                                            {% with event.ev_or_prod_images|first as image %}
                                                                <img src="{{ MEDIA_URL }}{{ image.path|modified_path:"list_image" }}{% if_has_perm "events.change_event" event %}?now={% now "YmdHis" %}{% end_if_has_perm %}" alt="{{ event.production.title|escape }}" />
                                                            {% endwith %}
                                                        {% else %}
                                                            <img src="{{ STATIC_URL }}site/img/placeholder_event.png" />
                                                        {% endif %}
                                                    </div>

                                                </div>
                                            </div>

                                            <!-- list item body -->
                                            <div class="list-item-body col-xs-12 col-sm-7 col-md-8 col-lg-9">
                                                <a class="list-item-link" href="{{ event.get_url_path }}{% remove_from_query "page" %}">
                                                    {% if event.production.in_program_of.exists or event.location_title or event.production.location_title or event.ev_or_prod_play_locations|length > 0 or event.ev_or_prod_play_stages|length > 0 %}
                                                        <dl>
                                                            {% if event.production.in_program_of.exists %}
                                                                {% for location in event.production.in_program_of.all %}
                                                                    <dd>
                                                                        {{ location.title }}
                                                                    </dd>
                                                                {% endfor %}
                                                            {% endif %}
                                                            {% if event.location_title %}
                                                                <dd>
                                                                    {{ event.location_title }}
                                                                </dd>
                                                            {% elif event.production.location_title %}
                                                                <dd>
                                                                    {{ event.production.location_title }}
                                                                </dd>
                                                            {% endif %}
                                                            {% for location in event.ev_or_prod_play_locations %}
                                                                <dd>
                                                                    {{ location.title }}
                                                                </dd>
                                                            {% endfor %}
                                                            {% for stage in event.ev_or_prod_play_stages %}
                                                                <dd>
                                                                    {{ stage.title }}
                                                                </dd>
                                                            {% endfor %}
                                                        </dl>
                                                    {% endif %}
                                                    {% if event.production.ensembles %}<h3>{{ event.production.ensembles }}</h3>{% endif %}
                                                    {% if event.production.title %}<h2>{% if event.production.prefix %}{{ event.production.prefix }} {% endif %}{{ event.production.title }}</h2>{% endif %}
                                                    {% if event.production.subtitle %}<h3>{{ event.production.subtitle }}</h3>
                                                    {% elif event.ev_or_prod_subtitles_text %}<h3>{{ event.ev_or_prod_subtitles_text }}</h3>{% endif %}
                                                    {% if event.production.original %}<h3>{{ event.production.original }}</h3>{% endif %}
                                                    {% if event.production.language_and_subtitles %}<h3>{{ event.production.language_and_subtitles }}</h3>{% endif %}
                                                    {% if event.ev_or_prod_teaser %}<div class="copy"><p>{{ event.ev_or_prod_teaser }}</p></div>{% endif %}
                                                    {% if event.get_special_text and not event.is_canceled %}<div class="extra"><span>{{ event.get_special_text }}</span></div>{% endif %}
                                                    {% if event.is_canceled %}<div class="extra canceled"><span>{% trans 'canceled' %}</span></div>{% endif %}
                                                </a>
                                            </div>

                                        </div>
                                    </div>
                                {% endwith %}
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                </div>
            {% else %}
                <h3>{% trans "Favorites" %}</h3>
                <p class="nothing">{% trans "You didn't favor any objects." %}</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}