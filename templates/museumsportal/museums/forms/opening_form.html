{% extends "museums/forms/base.html" %}
{% load i18n crispy_forms_tags %}

{% block multistep_form %}
<div id="item_container">
    <form>
        <fieldset>
            <legend>{% trans "Opening Hours" %}</legend>
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th><small>{% trans "Name" %}</small></th>
                        <th><small>{% trans "Date" %}</small></th>
                    </tr>
                </thead>
                <tbody id="season_list">
                    <tr class="hide"></tr>
                </tbody>
            </table>
            <a class="add btn btn-primary" id="add_season" href="#">{% trans "Add opening hours" %}</a>
        </fieldset>
        <fieldset>
            <legend>{% trans "Closing times / Holidays" %}</legend>
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th><small>{% trans "Name" %}</small></th>
                        <th><small>{% trans "Date" %}</small></th>
                    </tr>
                  </thead>
                <tbody id="special_opening_list">
                   <tr class="hide"></tr>
                </tbody>
              </table>
            <a class="add btn btn-primary" id="add_special_opening" href="#">{% trans "Add Closing time / Holiday" %}</a>
        </fieldset>
    </form>
</div>

<form action="" method="post">
{{ formsets.seasons.management_form }}
{{ formsets.special_openings.management_form }}

<div id="seasons">
    {% for form in formsets.seasons.forms %}
        <div class="season formset-form" style="display: none">
            {% crispy form %}
        </div>
    {% endfor %}
</div>
<!-- used by javascript -->
<div id="seasons_empty_form" class="season formset-form" style="display: none">
    {% with formsets.seasons.empty_form as form %}
        {% crispy form %}
    {% endwith %}
</div>

<div id="special_openings">
    {% for form in formsets.special_openings.forms %}
        <div class="special_opening formset-form" style="display: none">
            {% crispy form %}
        </div>
    {% endfor %}
</div>
<!-- used by javascript -->
<div id="special_openings_empty_form" class="special_opening formset-form" style="display: none">
    {% with formsets.special_openings.empty_form as form %}
        {% crispy form %}
    {% endwith %}
</div>

{% crispy form %}

</form>
<script type="text/javascript">
var error_messages = {
    required: "{% trans "This field is required." %}"
};

(function($, undefined) {
    function reinit_widgets() {
        $('#seasons .dateinput,#special_openings .dateinput').datepicker({
            format: 'dd.mm.yyyy',
            weekStart: 1
        });
        $('#seasons .timeinput,#special_openings .timeinput').timepicker({
            str_hours: '{% trans "Hours" %}',
            str_minutes: '{% trans "Minutes" %}',
            str_confirm: '{% trans "Confirm" %}',
            str_close: '{% trans "Close" %}'
        });
        $("select").not('[name*="__prefix__"]').not('[sb]').selectbox();
        
        $('textarea').each(function() {
          $(this).autosize();
        });
    }

    function set_index_for_fields($formset_form, index) {
        $formset_form.find(':input').each(function() {
            var $field = $(this);
            if ($field.attr("id")) {
                $field.attr(
                    "id",
                    $field.attr("id").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
            if ($field.attr("name")) {
                $field.attr(
                    "name",
                    $field.attr("name").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
        });
        $formset_form.find('label').each(function() {
            var $field = $(this);
            if ($field.attr("for")) {
                $field.attr(
                    "for",
                    $field.attr("for").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
        });
        $formset_form.find('div').each(function() {
            var $field = $(this);
            if ($field.attr("id")) {
                $field.attr(
                    "id",
                    $field.attr("id").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
        });
    }
        
    $(function() {
        $('#add_season').click(function() {
            var $total_forms = $('#id_seasons-TOTAL_FORMS');
            var $new_form = $('#seasons_empty_form').clone(true).attr("id", null).show();
            set_index_for_fields($new_form, parseInt($total_forms.val(), 10));
            $('#seasons').append($new_form);
            $total_forms.val(parseInt($total_forms.val(), 10) + 1);
            $('#item_container').hide();
            $('.form-actions:last').hide();
            reinit_widgets();
            return false;
        });
        $('#add_special_opening').click(function() {
            var $total_forms = $('#id_special_openings-TOTAL_FORMS');
            var $new_form = $('#special_openings_empty_form').clone(true).attr("id", null).show();
            set_index_for_fields($new_form, parseInt($total_forms.val(), 10));
            $('#special_openings').append($new_form);
            $total_forms.val(parseInt($total_forms.val(), 10) + 1);
            reinit_widgets();
            $('#item_container').hide();
            $('.form-actions:last').hide();
            return false;
        });
        
        $('.formset-form').each(function() {
            var $season = $(this);
            var $inlineControls = $(
                '<div class="form-actions">'
                + '<input type="button" class="save-link btn btn-lg btn-primary" value="{% trans "Okay" %}" />&nbsp;'
                + '<input name="cancel" type="button" class="delete btn btn-lg btn-default" value="{% trans "Delete" %}" />&nbsp;'
                + '</div>'
            );
            $season.append($inlineControls);
            $season.find('input:checkbox[id$=DELETE]').parent().hide();
        });
        function remove_error_messages($form) {
            $('.has-error', $form).removeClass("has-error").each(function() {
                $(this).find('.help-block').remove();
            });
        }
        function validate($form) {
            var success = true;
            remove_error_messages($form);
            // validate required fields
            $('.requiredField', $form).each(function() {
                var $control_group = $(this).closest('.form-group');
                if (!$(':input', $control_group).val()) {
                    $control_group.addClass("has-error");
                    success = false;
                    var $contols = $control_group.find('.controls');
                    $contols.find('.help-block').remove();
                    $contols.append(
                        '<span class="help-block"><strong>' + error_messages['required'] + '</strong></span>'
                    );
                }
            });
            // TODO: validate other errors
            if (!success) {
                $('body').scrollTop(0);
            }
            return success;
        }
        // SEASONS
        $('#seasons .save-link').live("click", function(event, close_form_anyway) {
            var $season = $(this).closest('.formset-form');
            var valid = validate($season);
            if (!close_form_anyway && !valid) {
                return;
            }
            $season.hide();
            var html = '<td><a class="edit control-label" href="#"><span class="title">' + $season.find('[name$="-title_' + settings.lang + '"]').val() + '</span></a></td>'
                +'<td><span class="date control-label">' + $season.find('[name$="-start"]').val() + ' - ' + $season.find('[name$="-end"]').val() + '</span></td>';
            if (!$season.data('mirror')) {
                if (valid) {
                    var $mirror = $('<tr class="item">' + html + '</tr>');
                } else {
                    var $mirror = $('<tr class="item has-error">' + html + '</tr>');
                }
                $('#season_list tr:last').before($mirror);
                $mirror.data('origin', $season);
                $season.data('mirror', $mirror);
            } else {
                var $mirror = $season.data('mirror');
                if (valid) {
                    $mirror.removeClass('has-error');
                }
                $mirror.html(html);
            }
            $('#item_container').show();
            $('.form-actions:last').show();
            return false;
        });
        $('#seasons .delete').live("click", function() {
            var $season = $(this).closest('.formset-form');
            var $checkbox = $season.find('input:checkbox[id$=DELETE]');
            $checkbox.attr("checked", "checked");
            $season.hide();
            var $mirror = $season.data('mirror');
            if ($mirror) {
                $mirror.remove();
            }
            $('#item_container').show();
            $('.form-actions:last').show();
            return false;
        });
        // SPECIAL OPENINGS
        $('#special_openings .save-link').on("click", function(event, close_form_anyway) {
            var $season = $(this).closest('.formset-form');
            var valid = validate($season);
            if (!close_form_anyway && !valid) {
                return;
            }
            $season.hide();
            var html = '<td><a class="edit control-label" href="#"><span class="title">' + $season.find('[name$="-day_label_' + settings.lang + '"]').val() + '</span></a></td>'
                + '<td><span class="date control-label">' + $season.find('[name$="-yyyy"]').val() + ' ' + $season.find('[name$="-mm"] option:selected').text() + ' ' + $season.find('[name$="-dd"]').val() + '</span></td>'
            ;
            if (!$season.data('mirror')) {
                if (valid) {
                    var $mirror = $('<tr class="item">' + html + '</tr>');
                } else {
                    var $mirror = $('<tr class="item has-error">' + html + '</tr>');
                }
                $('#special_opening_list tr:last').before($mirror);
                $mirror.data('origin', $season);
                $season.data('mirror', $mirror);
            } else {
                var $mirror = $season.data('mirror');
                if (valid) {
                    $mirror.removeClass('has-error');
                }
                $mirror.html(html);
            }
            $('#item_container').show();
            $('.form-actions:last').show();
            return false;
        });
        $('#special_openings .delete').on("click", function() {
            var $season = $(this).closest('.formset-form');
            var $checkbox = $season.find('input:checkbox[id$=DELETE]');
            $checkbox.attr("checked", "checked");
            $season.hide();
            var $mirror = $season.data('mirror');
            if ($mirror) {
                $mirror.remove();
            }
            $('#item_container').show();
            $('.form-actions:last').show();
            return false;
        });
        $('#item_container .edit').live("click", function() {
            var $mirror = $(this).closest('.item');
            var $origin = $mirror.data('origin');
            $origin.show();
            $('#item_container').hide();
            $('.form-actions:last').hide();
            return false;
        });
        
        // Initial state
        var $total_forms = $('#id_seasons-TOTAL_FORMS');
        if ($total_forms.val() == "0") {
            $('#add_season').click();
            $('#id_seasons-0-title_de').val("Ganzjährig");
            $('#id_seasons-0-title_en').val("Year-round");
            $('#id_seasons-0-start').val('01.01.' + (new Date()).getFullYear());
            $('#id_seasons-0-end').val('31.12.' + (new Date()).getFullYear());
            $(['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun']).each(function() {
                $('#id_seasons-0-' + this + '_open').val("10:00");
                $('#id_seasons-0-' + this + '_close').val("18:00");
            });
        }
        $(':input.save-link').trigger("click", [true]);
        reinit_widgets();
        
        // Working hours management
        var weekdays = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
        $('[id^="id_seasons"][id$="mon_open"]').live('keyup change', function(event) {
            var $mon = $(this);
            var $table = $(this).closest('table');
            $(weekdays).each(function() {
                if (this == 'mon') {
                    return;
                }
                var $day = $('[id^="id_seasons"][id$=' + this + '_open]', $table);
                if (!$day.data('changed')) {
                    $day.val($mon.val());
                }
            });
        });
        $('[id^="id_seasons"][id$="mon_break_close"]').live('keyup change', function(event) {
            var $mon = $(this);
            var $table = $(this).closest('table');
            $(weekdays).each(function() {
                if (this == 'mon') {
                    return;
                }
                var $day = $('[id^="id_seasons"][id$=' + this + '_break_close]', $table);
                if (!$day.data('changed')) {
                    $day.val($mon.val());
                }
            });
        });
        $('[id^="id_seasons"][id$="mon_break_open"]').live('keyup change', function(event) {
            var $mon = $(this);
            var $table = $(this).closest('table');
            $(weekdays).each(function() {
                if (this == 'mon') {
                    return;
                }
                var $day = $('[id^="id_seasons"][id$=' + this + '_break_open]', $table);
                if (!$day.data('changed')) {
                    $day.val($mon.val());
                }
            });
        });
        $('[id^="id_seasons"][id$="mon_close"]').live('keyup change', function(event) {
            var $mon = $(this);
            var $table = $(this).closest('table');
            $(weekdays).each(function() {
                if (this == 'mon') {
                    return;
                }
                var $day = $('[id^="id_seasons"][id$=' + this + '_close]', $table);
                if (!$day.data('changed')) {
                    $day.val($mon.val());
                }
            });
        });
        $(weekdays).each(function() {
            $('[id^="id_seasons"][id$="' + this + '_open"]').live('keyup change', function() {
                $(this).data('changed', true);
            }).each(function() {
                if ($(this).val()) {
                    $(this).data('changed', true);
                }
            });
            $('[id^="id_seasons"][id$="' + this + '_break_close"]').live('keyup change', function() {
                $(this).data('changed', true);
            }).each(function() {
                if ($(this).val()) {
                    $(this).data('changed', true);
                }
            });
            $('[id^="id_seasons"][id$="' + this + '_break_open"]').live('keyup change', function() {
                $(this).data('changed', true);
            }).each(function() {
                if ($(this).val()) {
                    $(this).data('changed', true);
                }
            });
            $('[id^="id_seasons"][id$="' + this + '_close"]').live('keyup change', function() {
                $(this).data('changed', true);
            }).each(function() {
                if ($(this).val()) {
                    $(this).data('changed', true);
                }
            });
        });
    });
})(jQuery);
</script>
{% endblock %}

