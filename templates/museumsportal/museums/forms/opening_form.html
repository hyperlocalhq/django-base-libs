{% extends "museums/forms/base.html" %}
{% load i18n crispy_forms_tags %}

{% block stylesheet %}
    {{ block.super }}
    <style type="text/css">
    .list {
        width: 100%;
        min-height: 150px;
    }
    .list li.item {
        background: #eee;
        height: 150px;
    }
    </style>
{% endblock %}

{% block multistep_form %}
<div id="item_container">
    <form>
        <fieldset>
            <legend>{% trans "Opening Hours" %}</legend>
            <a class="add" id="add_season" href="#">{% trans "Add opening hours" %}</a>
            <ul id="season_list">
                <li> </li>
            </ul>
        </fieldset>
        <fieldset>
            <legend>{% trans "Closing Times" %}</legend>
            <a class="add" id="add_special_opening" href="#">{% trans "Add closing time" %}</a>
            <ul id="special_opening_list">
                <li> </li>
            </ul>
        </fieldset>
    </form>
</div>

<form action="" method="post">
{{ formsets.seasons.management_form }}
{{ formsets.special_openings.management_form }}

<div id="seasons">
    {% for form in formsets.seasons.forms %}
        <div class="season formset-form" style="display: none">
            {% crispy form %}
        </div>
    {% endfor %}
</div>
<!-- used by javascript -->
<div id="seasons_empty_form" class="season formset-form" style="display: none">
    {% with formsets.seasons.empty_form as form %}
        {% crispy form %}
    {% endwith %}
</div>

<div id="special_openings">
    {% for form in formsets.special_openings.forms %}
        <div class="special_opening formset-form" style="display: none">
            {% crispy form %}
        </div>
    {% endfor %}
</div>
<!-- used by javascript -->
<div id="special_openings_empty_form" class="special_opening formset-form" style="display: none">
    {% with formsets.special_openings.empty_form as form %}
        {% crispy form %}
    {% endwith %}
</div>

{% crispy form %}
</form>
<script type="text/javascript">
var error_messages = {
    required: "{% trans "This field is required." %}"
};

(function($, undefined) {
    function reinit_widgets() {
        $('#seasons .dateinput,#special_openings .dateinput').datepicker({
            format: 'yyyy-mm-dd',
            weekStart: 1
        })
        $('#seasons .timeinput,#special_openings .timeinput').timepicker();
    }
    
    function set_index_for_fields($formset_form, index) {
        $formset_form.find(':input').each(function() {
            var $field = $(this);
            if ($field.attr("id")) {
                $field.attr(
                    "id",
                    $field.attr("id").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
            if ($field.attr("name")) {
                $field.attr(
                    "name",
                    $field.attr("name").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
        });
        $formset_form.find('label').each(function() {
            var $field = $(this);
            if ($field.attr("for")) {
                $field.attr(
                    "for",
                    $field.attr("for").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
        });
        $formset_form.find('div').each(function() {
            var $field = $(this);
            if ($field.attr("id")) {
                $field.attr(
                    "id",
                    $field.attr("id").replace(/-__prefix__-/, "-" + index + "-")
                );
            }
        });
    }
        
    $(function() {
        $('#add_season').click(function() {
            var $total_forms = $('#id_seasons-TOTAL_FORMS');
            var $new_form = $('#seasons_empty_form').clone(true).attr("id", null).show();
            set_index_for_fields($new_form, parseInt($total_forms.val(), 10));
            $('#seasons').append($new_form);
            $total_forms.val(parseInt($total_forms.val(), 10) + 1);
            $('#item_container').hide();
            $('.form-actions:last').hide();
            reinit_widgets();
            return false;
        });
        $('#add_special_opening').click(function() {
            var $total_forms = $('#id_special_openings-TOTAL_FORMS');
            var $new_form = $('#special_openings_empty_form').clone(true).attr("id", null).show();
            set_index_for_fields($new_form, parseInt($total_forms.val(), 10));
            $('#special_openings').append($new_form);
            $total_forms.val(parseInt($total_forms.val(), 10) + 1);
            reinit_widgets();
            $('#item_container').hide();
            $('.form-actions:last').hide();
            return false;
        });
        
        $('.formset-form').each(function() {
            var $season = $(this);
            var $inlineControls = $(
                '<div class="form-actions">'
                + '<input type="button" class="save-link btn btn-primary btn-small" value="{% trans "OK" %}" />&nbsp;'
                + '<input type="button" class="delete-link btn btn-small" value="{% trans "Delete" %}" />&nbsp;'
                + '</div>'
            );
            $season.append($inlineControls);
            $season.find('input:checkbox[id$=DELETE]').parent().hide();
        });
        function remove_error_messages($form) {
            $('.error', $form).removeClass("error").each(function() {
                $(this).find('.help-inline').remove();
            });
        }
        function validate($form) {
            var success = true;
            remove_error_messages($form);
            // validate required fields
            $('.requiredField', $form).each(function() {
                var $control_group = $(this).parents('.control-group:first');
                if (!$(':input', $control_group).val()) {
                    $control_group.addClass("error");
                    success = false;
                    $control_group.find('.controls').append(
                        '<span class="help-inline"><strong>' + error_messages['required'] + '</strong></span>'
                    );
                }
            });
            // TODO: validate other errors
            if (!success) {
                $('body').scrollTop(0);
            }
            return success;
        }
        // SEASONS
        $('#seasons .save-link').live("click", function() {
            var $season = $(this).parents('.formset-form:first');
            if (!validate($season)) {
                return;
            }
            $season.hide();
            var html = '<ul class="actions">'
                + '<li><button rel="tooltip" data-placement="top" data-original-title="Edit" class="transparent edit icon icon-edit"></button></li>'
                + '</ul>'
                + '<a class="edit" href="#"><span class="title">' + $season.find('[name$="-title_' + settings.lang + '"]').val() + '</span> ' + $season.find('[name$="-start"]').val() + ' - ' + $season.find('[name$="-end"]').val() + '</a>';
            if (!$season.data('mirror')) {
                var $mirror = $('<li class="item">' + html + '</li>');
                $('#season_list li:last').before($mirror);
                $mirror.data('origin', $season);
                $season.data('mirror', $mirror);
            } else {
                var $mirror = $season.data('mirror');
                $mirror.html(html);
            }
            $('#item_container').show();
            $('.form-actions:last').show();
            return false;
        });
        $('#seasons .delete-link').live("click", function() {
            var $season = $(this).parents('.formset-form:first');
            var $checkbox = $season.find('input:checkbox[id$=DELETE]');
            $checkbox.attr("checked", "checked");
            $season.hide();
            var $mirror = $season.data('mirror');
            if ($mirror) {
                $mirror.remove();
            }
            $('#item_container').show();
            $('.form-actions:last').show();
            return false;
        });
        // SPECIAL OPENINGS
        $('#special_openings .save-link').live("click", function() {
            var $season = $(this).parents('.formset-form:first');
            if (!validate($season)) {
                return;
            }
            $season.hide();
            var html = '<ul class="actions">'
                + '<li><button rel="tooltip" data-placement="top" data-original-title="Edit" class="edit transparent icon icon-edit"></a></li>'
                + '</ul>'
                + '<a class="edit" href="#"><span class="title">' + $season.find('[name$="-day_label_' + settings.lang + '"]').val() + '</span> ' + $season.find('[name$="-yyyy"]').val() + ' ' + $season.find('[name$="-mm"] option:selected').text() + ' ' + $season.find('[name$="-dd"]').val() + '</a>';
            if (!$season.data('mirror')) {
                var $mirror = $('<li class="item">' + html + '</li>');
                $('#special_opening_list li:last').before($mirror);
                $mirror.data('origin', $season);
                $season.data('mirror', $mirror);
            } else {
                var $mirror = $season.data('mirror');
                $mirror.html(html);
            }
            $('#item_container').show();
            $('.form-actions:last').show();
            return false;
        });
        $('#special_openings .delete-link').live("click", function() {
            var $season = $(this).parents('.formset-form:first');
            var $checkbox = $season.find('input:checkbox[id$=DELETE]');
            $checkbox.attr("checked", "checked");
            $season.hide();
            var $mirror = $season.data('mirror');
            if ($mirror) {
                $mirror.remove();
            }
            $('#item_container').show();
            $('.form-actions:last').show();
            return false;
        });
        $('#item_container .edit').live("click", function() {
            var $mirror = $(this).parents('.item:first');
            var $origin = $mirror.data('origin');
            $origin.show();
            $('#item_container').hide();
            $('.form-actions:last').hide();
            return false;
        });
        
        // Initial state
        var $total_forms = $('#id_seasons-TOTAL_FORMS');
        if ($total_forms.val() == "0") {
            $('#add_season').click();
            $('#id_seasons-0-title_de').val("Ganzjährige Öffnungszeiten");
            $('#id_seasons-0-title_en').val("Year-round opening times");
            $('#id_seasons-0-start').val((new Date()).getFullYear()+"-01-01");
            $('#id_seasons-0-end').val((new Date()).getFullYear()+"-12-31");
            $(['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun']).each(function() {
                $('#id_seasons-0-' + this + '_open').val("10:00");
                $('#id_seasons-0-' + this + '_close').val("18:00");
            });
            $(':input.save-link').click();
        }
        reinit_widgets();
        
        // Working hours management
        var weekdays = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
        $('[id^="id_seasons"][id$="mon_open"]').live('keyup change', function(event) {
            var $mon = $(this);
            var $table = $(this).parents('table:first');
            $(weekdays).each(function() {
                if (this == 'mon') {
                    return;
                }
                var $day = $('[id^="id_seasons"][id$=' + this + '_open]', $table);
                if (!$day.data('changed')) {
                    $day.val($mon.val());
                }
            });
        });
        $('[id^="id_seasons"][id$="mon_break_close"]').live('keyup change', function(event) {
            var $mon = $(this);
            var $table = $(this).parents('table:first');
            $(weekdays).each(function() {
                if (this == 'mon') {
                    return;
                }
                var $day = $('[id^="id_seasons"][id$=' + this + '_break_close]', $table);
                if (!$day.data('changed')) {
                    $day.val($mon.val());
                }
            });
        });
        $('[id^="id_seasons"][id$="mon_break_open"]').live('keyup change', function(event) {
            var $mon = $(this);
            var $table = $(this).parents('table:first');
            $(weekdays).each(function() {
                if (this == 'mon') {
                    return;
                }
                var $day = $('[id^="id_seasons"][id$=' + this + '_break_open]', $table);
                if (!$day.data('changed')) {
                    $day.val($mon.val());
                }
            });
        });
        $('[id^="id_seasons"][id$="mon_close"]').live('keyup change', function(event) {
            var $mon = $(this);
            var $table = $(this).parents('table:first');
            $(weekdays).each(function() {
                if (this == 'mon') {
                    return;
                }
                var $day = $('[id^="id_seasons"][id$=' + this + '_close]', $table);
                if (!$day.data('changed')) {
                    $day.val($mon.val());
                }
            });
        });
        $(weekdays).each(function() {
            $('[id^="id_seasons"][id$="' + this + '_open"]').live('keyup change', function() {
                $(this).data('changed', true);
            }).each(function() {
                if ($(this).val()) {
                    $(this).data('changed', true);
                }
            });
            $('[id^="id_seasons"][id$="' + this + '_break_close"]').live('keyup change', function() {
                $(this).data('changed', true);
            }).each(function() {
                if ($(this).val()) {
                    $(this).data('changed', true);
                }
            });
            $('[id^="id_seasons"][id$="' + this + '_break_open"]').live('keyup change', function() {
                $(this).data('changed', true);
            }).each(function() {
                if ($(this).val()) {
                    $(this).data('changed', true);
                }
            });
            $('[id^="id_seasons"][id$="' + this + '_close"]').live('keyup change', function() {
                $(this).data('changed', true);
            }).each(function() {
                if ($(this).val()) {
                    $(this).data('changed', true);
                }
            });
        });
    });
})(jQuery);
</script>
{% endblock %}

