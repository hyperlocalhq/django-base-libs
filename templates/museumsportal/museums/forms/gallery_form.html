{% extends "museums/forms/base.html" %}
{% load i18n crispy_forms_tags %}

{% block js %}
<script src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
{% endblock %}

{% block multistep_form %}
<div id="photos" data-load-url="/{{ LANGUAGE_CODE }}{{ museum.get_url_path }}gallery/"></div>

<div id="edit_photo"></div>
<a id="add_photo" href="/{{ LANGUAGE_CODE }}{{ museum.get_url_path }}gallery/add/">{% trans "Add photo" %}</a>

{% crispy form %}
<script type="text/javascript">
(function($, undefined) {
    function reinit() {
        $('#photos').each(function() {
            var load_url = $(this).data("load-url");
            $(this).load(load_url + ' #photos>*', function() {
                $('#photos').sortable({
                    placeholder: "ui-state-highlight",
                    update: function(event, ui) {
                        var tokens = []
                        $('.img_and_desc', '#photos').each(function() {
                            tokens[tokens.length] = $(this).data('token');
                        });
                        $.post(load_url, {ordering: tokens.join(',')});
                    }
                })
                $('#photos').disableSelection().find('.edit_photo').click(function() {
                    $('#edit_photo').load($(this).attr('href') + ' .content form', function() {
                        $('#id_goto_next').val(location.href);
                        $('#button-id-cancel').click(function() {
                            $('#edit_photo').html("");
                        });
                    });
                    return false;
                });
                $('#photos').find('.delete_photo').click(function() {
                    $('#edit_photo').load($(this).attr('href') + ' .content form', function() {
                        $('#id_goto_next').val(location.href);
                        $('#button-id-cancel').click(function() {
                            $('#edit_photo').html("");
                        });
                    });
                    return false;
                });
                $('#photos').find('.crop_photo').each(function() {
                    $(this).attr('href', $(this).attr('href').replace(/goto_next=.+$/gim, "goto_next=" + location.href));
                });
            });
        });
    }
    $(function() {
        reinit();
        $('#add_photo').click(function() {
            $('#edit_photo').load($(this).attr('href') + ' .content form', function() {
                $('#id_goto_next').val(location.href);
                $('#button-id-cancel').click(function() {
                    $('#edit_photo').html("");
                });
            });
            return false;
        });
    });
})(jQuery);
</script>
{% endblock %}

