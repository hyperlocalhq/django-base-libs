<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Museumsportal Berlin {% block title %}{% endblock %}</title>
    <link rel="icon" href="{{ STATIC_URL }}site/img/favicon.ico" type="image/png">
    <link href="{{ STATIC_URL }}site/css/twitterwall_box.css" rel="stylesheet" media="screen" type="text/css" />
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
</head>
<body>

    <div class="tweet-box">
        <div id="tweets" class="tweet-list">
            {% for tweet in tweets %}
                {% include "twitterwall/box_tweet.html" %}
            {% endfor %}
        </div>
    </div>

    <script type="text/javascript">
        (function($, undefined) {
            var loading_timeout = null;
            var view_timeout = null;
            var logo_timeout = null;
            var cleanup_timeout = null;
            var LOADING_TIMEOUT_DELAY = 5000;
            var VIEW_TIMEOUT_DELAY = 4000;
            var LOGO_TIMEOUT_DELAY = 30000;
            var TRANSITION_DURATION = 500;
            var CLEANUP_TIMEOUT_DELAY = 60000;

            function insert_logo() {
                // inserts logo screens after the first or the entering tweet
                clearTimeout(logo_timeout);
                if (!$('.logo').length) {
                    $(
                        '<div class="tweet logo">Willkommen zur <br />Langen Nacht der Museen</div>' +
                        '<div class="tweet logo">Jetzt live mit-tweeten:<br />#LNBerlin</div>' +
                        '<div class="tweet logo">und mitverfolgen auf:<br />www.twitter.com/museumsnachtB</div>' +
                        '<div class="tweet logo">Mit freundlicher Unterstützung von:<br />Werther´s Original</div>'
                    ).insertAfter($('.tweet').filter('.active,.in').get(0));
                }
                logo_timeout = setTimeout(insert_logo, LOGO_TIMEOUT_DELAY);
            }

            function cleanup_stack() {
                // deletes all tweets except first, second, and last three
                $('.tweet').not(':eq(0),:eq(1),:eq(-1),:eq(-2),:eq(-3),.logo').remove();
                cleanup_timeout = setTimeout(cleanup_stack, CLEANUP_TIMEOUT_DELAY);
            }

            function load_tweets() {
                var $tweets = $('#tweets');
                var url = "{% url load_box_tweets %}";
                var since_id = $tweets.find('.tweet:last').data("tweet-id");
                if (since_id) {
                    since_id = since_id.replace(/t/, "");
                    url += "?since_id=" + since_id;
                }
                $.get(url, function(data) {
                    $tweets.append(data);
                    $('a:contains("pic.twitter.com")', $tweets).remove();
                    loading_timeout = setTimeout(load_tweets, LOADING_TIMEOUT_DELAY);
                }, "html");
            }

            var tweet_class_index = 1;

            var bg_positions = {
                t1: {'background-position-x': '-100px', 'background-position-y': '300px'},
                t2: {'background-position-x': '-100px', 'background-position-y': '400px'},
                t3: {'background-position-x': '-300px', 'background-position-y': '600px'},
                t4: {'background-position-x': '-600px', 'background-position-y': '500px'},
                t5: {'background-position-x': '-150px', 'background-position-y': '1000px'},
                t6: {'background-position-x': '-100px', 'background-position-y': '700px'}
            };

            function show_next_tweet() {
                if ($('.tweet').length < 2) {
                    insert_logo();
                }
                var $first_tweet = $('.tweet:eq(0)');
                var $second_tweet = $('.tweet:eq(1)');
                var animate_second_tweet_to = {top: '0%', opacity: 1};
                if (!$second_tweet.is('.logo')) {
                    // add t1, t2, or t3 class to the tweet which will be active soon
                    tweet_class_index++;
                    if (tweet_class_index > 6) {
                        tweet_class_index = 1;
                    }
                    $second_tweet.addClass('t' + tweet_class_index);
                    animate_second_tweet_to = $.extend(animate_second_tweet_to, bg_positions['t' + tweet_class_index]);
                }
                $first_tweet.addClass('out').animate({top: '-100%', opacity: 0}, TRANSITION_DURATION).removeClass('active');
                $second_tweet.addClass('in').animate(animate_second_tweet_to, TRANSITION_DURATION).queue(function() {
                    $first_tweet.remove();
                    $second_tweet.addClass('active').removeClass('in');
                    $(this).dequeue();
                    view_timeout = setTimeout(show_next_tweet, VIEW_TIMEOUT_DELAY);
                });
            }

            $(document).ready(function() {
                $('.tweet:first').addClass('active').addClass('t1');
                loading_timeout = setTimeout(load_tweets, LOADING_TIMEOUT_DELAY);
                view_timeout = setTimeout(show_next_tweet, VIEW_TIMEOUT_DELAY);
                logo_timeout = setTimeout(insert_logo, LOGO_TIMEOUT_DELAY);
                cleanup_timeout = setTimeout(cleanup_stack, CLEANUP_TIMEOUT_DELAY);
            });
        }(jQuery))
    </script>
</body>
</html>
