<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Museumsportal Berlin {% block title %}{% endblock %}</title>
    <link rel="icon" href="{{ STATIC_URL }}site/img/favicon.ico" type="image/png">
    <link href="{{ STATIC_URL }}site/css/twitterwall_box.css" rel="stylesheet" media="screen" type="text/css" />
    <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
</head>
<body>

    <div class="tweet-box">
        <div id="tweets" class="tweet-list">
            {% for tweet in tweets %}
                {% include "twitterwall/box_tweet.html" %}
            {% endfor %}
        </div>
    </div>

    <script type="text/javascript">
        (function($, undefined) {
            var loading_timeout = null;
            var view_timeout = null;
            var logo_timeout = null;
            var cleanup_timeout = null;
            var LOADING_TIMEOUT_DELAY = 10000;
            var VIEW_TIMEOUT_DELAY = 5500;
            var TRANSITION_DURATION = 500;
            // show 4 logos after every 15 tweets
            var LOGO_TIMEOUT_DELAY = (VIEW_TIMEOUT_DELAY + TRANSITION_DURATION) * (4 + 15);
            var CLEANUP_TIMEOUT_DELAY = 60000;
            var $tweets = $('#tweets');

            function insert_logo() {
                // inserts logo screens after the first or the entering tweet
                clearTimeout(logo_timeout);
                $(
                    '<div class="tweet logo langenacht ln-1"><p>Willkommen zur <br /><b>Langen Nacht der Museen</b></p></div>' +
                    '<div class="tweet logo langenacht ln-2"><p>Jetzt live mit-tweeten:<br /><b>#LNBerlin</b></p></div>' +
                    '<div class="tweet logo langenacht ln-3"><p><b>und mitverfolgen auf:</b><br /><small>www.twitter.com/museumsnachtB</small></p></div>' +
                    '<div class="tweet logo werthers"></div>'
                ).insertAfter($('.tweet', $tweets).filter('.active,.in').get(0));
                logo_timeout = setTimeout(insert_logo, LOGO_TIMEOUT_DELAY);
            }

            function cleanup_stack() {
                // deletes all tweets except logos, first, second, and last three
                clearTimeout(cleanup_timeout);
                $('.tweet', $tweets).not(':eq(0),:eq(1),:eq(-1),:eq(-2),:eq(-3),.logo').remove();
                cleanup_timeout = setTimeout(cleanup_stack, CLEANUP_TIMEOUT_DELAY);
            }

            function append_new_tweets($source, $target) {
                // appends non-duplicating tweets from temporary $source to the $target
                $('a:contains("pic.twitter.com")', $source).remove();
                $('.tweet', $source).each(function() {
                    if (!$('.tweet[data-tweet-id="' + $(this).attr('data-tweet-id') + '"]', $target).length) {
                        $target.append($(this));
                    }
                });
            }

            function load_tweets() {
                clearTimeout(loading_timeout);
                var url = "{% url load_box_tweets %}";
                var since_id = $('.tweet:last', $tweets).data("tweet-id");
                if (since_id) {
                    since_id = since_id.replace(/t/, "");
                    url += "?since_id=" + since_id;
                }
                $.get(url, function(data) {
                    var $tmp = $('<div></div>').append(data);
                    append_new_tweets($tmp, $tweets);
                    loading_timeout = setTimeout(load_tweets, LOADING_TIMEOUT_DELAY);
                }, "html");
            }

            var tweet_class_index = 1;

            var bg_positions = {
                t1:  {'background-position-x': '-100px', 'background-position-y': '300px'},
                t2:  {'background-position-x': '-100px', 'background-position-y': '400px'},
                t3:  {'background-position-x': '-300px', 'background-position-y': '600px'},
                t4:  {'background-position-x': '-600px', 'background-position-y': '500px'},
                t5:  {'background-position-x': '-150px', 'background-position-y': '1000px'},
                t6:  {'background-position-x': '-100px', 'background-position-y': '700px'},

                t7:  {'background-position-x': '-160px', 'background-position-y': '1700px'},
                t8:  {'background-position-x': '1300px', 'background-position-y': '1980px'},
                t9:  {'background-position-x': '-0px', 'background-position-y': '1900px'},
                t10: {'background-position-x': '-750px', 'background-position-y': '750px'},
                t11: {'background-position-x': '-1000px', 'background-position-y': '250px'},
                t12: {'background-position-x': '-300px', 'background-position-y': '1200px'}
            };

            function show_next_tweet() {
                clearTimeout(view_timeout);
                if ($('.tweet', $tweets).length < 4) {
                    // security check: load tweets if there are less than 4 tweets in the stack
                    load_tweets();
                }
                var $first_tweet = $('.tweet:eq(0)', $tweets);
                var $second_tweet = $('.tweet:eq(1)', $tweets);
                if (!$second_tweet.length) {
                    // another security check: reload page if there is no other tweet in the stack
                    location.href = location.href;
                }
                var animate_second_tweet_to = {top: '0%', opacity: 1};
                if (!$second_tweet.is('.werthers')) {
                    // add t1, t2, or t3 class to the tweet which will be active soon
                    tweet_class_index++;
                    if (tweet_class_index > 12) {
                        tweet_class_index = 1;
                    }
                    $second_tweet.addClass('t' + tweet_class_index);
                    animate_second_tweet_to = $.extend(animate_second_tweet_to, bg_positions['t' + tweet_class_index]);
                }
                $first_tweet.addClass('out').animate({top: '-100%', opacity: 0}, TRANSITION_DURATION).removeClass('active');
                $second_tweet.addClass('in').animate(animate_second_tweet_to, TRANSITION_DURATION).queue(function() {
                    $first_tweet.remove();
                    $second_tweet.addClass('active').removeClass('in');
                    $(this).dequeue();
                    view_timeout = setTimeout(show_next_tweet, VIEW_TIMEOUT_DELAY);
                });
            }

            $(function() {
                $('.tweet:first', $tweets).addClass('active').addClass('t1');
                insert_logo();
                loading_timeout = setTimeout(load_tweets, LOADING_TIMEOUT_DELAY);
                view_timeout = setTimeout(show_next_tweet, VIEW_TIMEOUT_DELAY);
                cleanup_timeout = setTimeout(cleanup_stack, CLEANUP_TIMEOUT_DELAY);
            });
        }(jQuery))
    </script>
</body>
</html>
