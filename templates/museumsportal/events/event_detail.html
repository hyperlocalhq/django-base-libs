{% extends "base.html" %}
{% load base_tags i18n image_modifications tagging_tags babel auth_extended %}
{% block title %}{% trans "Event" %} – {{ object.title }}{% endblock %}
{% block bodyclass %}event-detail{% endblock %}

{% block js %}
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&amp;language={{ LANGUAGE_CODE }}"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}site/js/swipe.js"></script>
    <script type="text/javascript">
        var aGeopositions = [];
        var settings = {
            STATIC_URL: "{{ STATIC_URL }}"
        }

        $(document).ready(function(){
            $(".toggle_bvg").click(function () {
                $("#bvg_widget").toggleClass("on");
                return false;
            });
        });
    </script>
{% endblock %}

{% block edit_item %}
    {% if_has_perm "events.change_event" object %}
    <li><a class="edit icon icon-edit" rel="tooltip" data-placement="bottom" data-original-title="{% trans "Edit" %}" href="{{ request.path }}change/">&nbsp;<span>{% trans "Edit" %}</span></a></li>
    {% end_if_has_perm %}
{% endblock %}

{% block content %}
{% include "utils/gmap.html" %}

<div class="content clearfix">
  <div class="inner">
    {% with object as event %}

        {% include "utils/cover_image.html" %}
        
        <section class="sidebar">
            <ul class="accordion" id="accordion2">  
                <li class="accordion-group">  
                    <h4 class="accordion-heading">  
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapse-location">  
                            {% trans "Location" %}
                        </a>
                    </h4>
                    <ul id="collapse-location" class="accordion-body collapse">  
                        <li class="accordion-inner">
                            {% if event.street_address %}
                                <dl class="address">
                                    <dt>{% trans "Address" %}</dt>
                                    <dd>{{ event.location_name }}</dd>
                                    <dd>{{ event.street_address }}</dd>
                                    {% if event.street_address2 %}<dd>{{ event.street_address2 }}</dd>{% endif %} 
                                    <dd>{{ event.postal_code }} {{ event.city }}</dd>
                                </dl>
                            {% else %}
                                {% with event.museum as museum %}
                                    <dl class="address">
                                        <dt>{% trans "Address" %}</dt>
                                        <dd>{{ museum.title }}</dd>
                                        <dd>{{ museum.street_address }}</dd>
                                        {% if museum.street_address2 %}<dd>{{ museum.street_address2 }}</dd>{% endif %} 
                                        <dd>{{ museum.postal_code }} {{ museum.city }}</dd>
                                    </dl>
                                {% endwith %}
                            {% endif %}
                            {% if event.organizing_museum %}
                                <dl>
                                    <dt>{% trans "Organizer" %}</dt>
                                    <dd><a href="{{ event.organizing_museum.get_url_path }}">{{ event.organizing_museum.title }}</a></dd>
                                </dl>
                            {% else %}
                                {% if event.organizer_title %}
                                    <dl>
                                        <dt>{% trans "Organizer" %}</dt>
                                        {% if event.organizer_url_link %}
                                            <dd><a href="{{ event.organizer_url_link }}">{{ event.organizer_title }}</a></dd>
                                        {% else %}
                                            <dd>{{ event.organizer_title }}</dd>
                                        {% endif %}
                                    </dl>
                                {% endif %}
                            {% endif %}
                            {% if event.event %}
                                <dl>
                                    <dt>{% trans "Related event" %}</dt>
                                    <dd><a href="{{ event.event.get_url_path }}">{{ event.event.title }}</a></dd>
                                </dl>
                            {% endif %}
                        </li>
                        <li class="accordion-inner">  
                            <button rel="tooltip" data-placement="top" data-original-title="{% trans "Show location on map" %}" class="location icon icon-location"></button>
        
                            {% with event.museum as museum %}
                                {% if museum.latitude %}
                                    <script type="text/javascript">
                                    //<![CDATA[
                                    (function(undefined) {
                                        var iIndex = aGeopositions.length;
                                        aGeopositions[iIndex] = {
                                            latitude: {{ museum.latitude }},
                                            longitude: {{ museum.longitude }},
                                            categories: "initial_{{ event.title|slugify|slice:"0:1" }}{% if event.closing_soon %} closing_soon{% endif %}{% if event.newly_opened %} newly_opened{% endif %}{% for cat in event.categories.all %} cat_{{ cat.title|slugify }}{% endfor %}",
                                            content: 
                                            '<a href="{{ event.get_url_path }}">{{ museum.title }} <span>{% trans "more" %}</span></a>'
                                        }
                                    }());
                                    //]]>
                                    </script>
                                {% endif %}
                            {% endwith %}
                            
                            <a class="toggle_bvg" href="#">{% if LANGUAGE_CODE == "de" %}BVG Suche{% else %}BVG Search{% endif %}</a>
                        </li>
                    </ul>  
                </li>
                {% if museum.season_set.count or museum.specialopeningtime_set.count %}
                    <li class="accordion-group">  
                        <h4 class="accordion-heading">  
                            <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapse-opening-times">
                                {% trans "Opening hours" %}
                            </a>  
                        </h4>  
                        <ul id="collapse-opening-times" class="accordion-body collapse" style="height: 0px; ">
                            <li class="accordion-inner">
                                {% if museum.season_set.count == 1 %}
                                    {% with museum.season_set.all.0 as season %}
                                        {% if season.is_appointment_based %}
                                            <p>{% trans "Based on appointment" %}</p>
                                        {% else %}
                                            {% regroup season.get_opening_hours by times as opening_hours %}
                                            {% for same_hours in opening_hours %}
                                                {% if forloop.first %}<dl>{% endif %}
                                                <dt>{% for day in same_hours.list %}{% if forloop.first %}{{ day.weekday }}{% endif %}{% if forloop.last %}{% if forloop.counter0 %}-{{ day.weekday }}{% endif %}{% endif %}{% endfor %}</dt>
                                                <dd>
                                                    {% if same_hours.list.0.open %}
                                                         {{ same_hours.list.0.open|time:"H:i" }}
                                                         {% if same_hours.list.0.break_close %}
                                                            - {{ same_hours.list.0.break_close|time:"H:i" }}
                                                              / {{ same_hours.list.0.break_open|time:"H:i" }}
                                                            - {{ same_hours.list.0.close|time:"H:i" }}
                                                         {% else %}
                                                            - {{ same_hours.list.0.close|time:"H:i" }}
                                                         {% endif %}
                                                    {% else %}               
                                                        {% trans "closed" %}
                                                    {% endif %}
                                                </dd>
                                                {% if forloop.last %}</dl>{% endif %}
                                            {% endfor %}                                   
                                        {% endif %}
                                        {% if season.last_entry %}
                                            <div class="last_entry">{% trans "Last entry" %}: {{ season.last_entry }}</div>
                                        {% endif %}
                                        {% if season.exceptions %}
                                            <div class="exceptions">{{ season.get_rendered_exceptions }}</div>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    {% for season in museum.season_set.all %}
                                        <h5>{% trans "Season" %} {{ season.start|date:"j. F Y" }} - {{ season.end|date:"j. F Y" }}</h5>
                                        {% if season.is_appointment_based %}
                                            <p>{% trans "Based on appointment" %}</p>
                                        {% else %}
                                            {% regroup season.get_opening_hours by times as opening_hours %}
                                            {% for same_hours in opening_hours %}
                                                {% if forloop.first %}<dl>{% endif %}
                                                <dt>{% for day in same_hours.list %}{% if forloop.first %}{{ day.weekday }}{% endif %}{% if forloop.last %}{% if forloop.counter0 %}-{{ day.weekday }}{% endif %}{% endif %}{% endfor %}</dt>
                                                <dd>
                                                    {% if same_hours.list.0.open %}
                                                         {{ same_hours.list.0.open|time:"H:i" }}
                                                         {% if same_hours.list.0.break_close %}
                                                            - {{ same_hours.list.0.break_close|time:"H:i" }}
                                                              / {{ same_hours.list.0.break_open|time:"H:i" }}
                                                            - {{ same_hours.list.0.close|time:"H:i" }}
                                                         {% else %}
                                                            - {{ same_hours.list.0.close|time:"H:i" }}
                                                         {% endif %}
                                                    {% else %}               
                                                        {% trans "closed" %}
                                                    {% endif %}
                                                </dd>
                                                {% if forloop.last %}</dl>{% endif %}
                                            {% endfor %}                                   
                                        {% endif %}
                                        {% if season.last_entry %}
                                            <div class="last_entry">{% trans "Last entry" %}: {{ season.last_entry }}</div>
                                        {% endif %}
                                        {% if season.exceptions %}
                                            <div class="exceptions">{{ season.get_rendered_exceptions }}</div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                
                                {% if museum.specialopeningtime_set.count %}
                                    <h5>{% trans "Special Opening hours" %}</h5>
                                    {% for special_opening in museum.specialopeningtime_set.all %}
                                        <h6>{% if special_opening.day_label %}{{ special_opening.day_label }}{% endif %}
                                        {{ special_opening.dd }}. {{ special_opening.get_mm_display }} {{ special_opening.yyyy|default:"" }}
                                        </h6>
                                        {% if special_opening.is_closed %}
                                            {% trans "Closed" %}
                                        {% else %}
                                            {% if special_opening.is_regular %}
                                                {% trans "Regular Opening hours" %}
                                            {% else %}
                                                {{ special_opening.opening|time:"H:i" }} - {{ special_opening.closing|time:"H:i" }}
                                                {% if season.sun_break_close %}
                                                    | {% trans "Break:" %} {{ special_opening.break_close|time:"H:i" }} - {{ special_opening.break_open|time:"H:i" }}
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </li>
                        </ul>  
                    </li>
                {% endif %}

                <!-- ======= Other Events ======= -->

                {% if object.get_other_events %}
                    <li class="accordion-group">  
                        <h4 class="accordion-heading">  
                            <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapse-times">  
                                {% trans "Opening Hours" %}
                            </a>
                        </h4>
                        <ul id="collapse-times" class="accordion-body collapse">  
                            <li class="accordion-inner">
                                {% for event_time in event.eventtime_set.all %}
                                    <p>
                                        {{ event_time.event_date|date:"j. F Y" }}
                                        {{ event_time.start|time:"H:i" }}{% if event_time.end %} {% trans "till" %} {{ event_time.end|time:"H:i" }}{% endif %}
                                    </p>
                                {% endfor %}
                            </li>
                        </ul>  
                    </li>
                {% endif %} 

                <!-- ======= Other Events ======= -->

                {% if object.get_other_events %}
                    <li class="accordion-group">  
                        <h4 class="accordion-heading">  
                            <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapse-prices">  
                                {% trans "Prices" %} 
                            </a>  
                        </h4>  
                        <ul id="collapse-prices" class="accordion-body collapse">  
                            <li class="accordion-inner">
                                <dl>
                                {% if event.free_entrance %}
                                    <dt>{% trans "Free entrance" %}</dt>
                                {% else %}
                                    {% if event.admission_price %}
                                        <dt>{% trans "Admission price" %}: {{ event.admission_price|currencyfmt:"EUR" }}</dt>
                                    {% endif %}
                                    {% if event.admission_price_info %}
                                        <dd class="admission_price_info">{{ event.get_rendered_admission_price_info }}</dd>
                                    {% endif %}
                                    {% if event.reduced_price %}
                                        <dt>{% trans "Reduced price" %}: {{ event.reduced_price|currencyfmt:"EUR" }}</dt>
                                    {% endif %}
                                    {% if event.reduced_price_info %}
                                        <dd class="reduced_price_info">{{ event.get_rendered_reduced_price_info }}</dd>
                                    {% endif %}
                                {% endif %}
                                {% if event.booking_info %}
                                    <dt>{% trans "Booking info" %}</dt>
                                    <dd class="booking_info">{{ event.get_rendered_booking_info }}</dd>
                                {% endif %}
                                </dl>
                            </li>
                        </ul>  
                    </li>
                {% endif %} 

                <!-- ======= Other Events ======= -->

                {% if event.meeting_place or event.get_languages %}
                    <li class="accordion-group">  
                        <h4 class="accordion-heading">  
                            <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapse-other-info">  
                                {% trans "Other info" %} 
                            </a>  
                        </h4>  
                        <ul id="collapse-other-info" class="accordion-body collapse">  
                            <li class="accordion-inner">
                                {% if event.meeting_place %}
                                    <dl>
                                        <dt>{% trans "Meeting point" %}</dt>
                                        <dd class="meeting_place">{{ event.meeting_place }}</dd>
                                    </dl>
                                {% endif %}
                                {% if event.get_languages %}
                                    <dl>
                                        <dt>{% trans "Languages" %}</dt>
                                        <dd class="languages">{{ event.get_languages|join:", " }}</dd>
                                    </dl>
                                {% endif %}
                            </li>
                        </ul>  
                    </li>
                {% endif %} 

                <!-- ======= Other Events ======= -->

                {% if object.get_other_events %}
                    <li class="accordion-group">  
                        <h4 class="accordion-heading">  
                            <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapse-events">{% trans "Other Events" %}</a>  
                        </h4>  
                        <ul id="collapse-events" class="accordion-body collapse">
                            <li class="accordion-inner">
                                <ul class="list compact">
                                {% for event in object.get_other_events %}
                                    <li class="item">
                                        {% if event.cover_image %}
                                            <a class="img" href="{{ event.get_url_path }}" style="background-image: url({{ MEDIA_URL }}{{ event.cover_image|modified_path:"event_list" }})"></a>
                                        {% endif %}
            
                                        <a href="{{ event.get_url_path }}">
                                            <h3>{{ event.museum.title }}</h3>
                                            <h4>{{ event.title }}</h4>
                                            {% with event.eventtime_set.all.0 as event_time %}
                                                <h5>{{ event_time.event_date|date:"j. F Y" }} {{ event_time.start|date:"H:i" }}</h5>
                                            {% endwith %}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                            </li>
                        </ul>  
                    </li> 
                {% endif %} 
            </ul> 

        </section>
            
        <article class="with_sidebar">
            <header>
                <h1>
                    {{ event.title }}
                     {% if event.subtitle %}
                        <span>{{ event.subtitle }}</span>
                    {% endif %}
                </h1>

                <time>
                    {% if event.permanent %}{% trans "Permanent event" %}{% else %}
            
                    {% for event_time in event.eventtime_set.all %}
                            {{ event_time.event_date|date:"j. F Y" }} – 
                            {{ event_time.start|time:"H:i" }}{% if event_time.end %} {% trans "till" %} {{ event_time.end|time:"H:i" }}{% endif %}
                    {% endfor %}

                    <!-- <span class="from_date">{{ event.start|date:"j. F Y" }}</span> {% trans "till" %} {{ event.end|date:"j. F Y" }} -->

                    {% endif %}
                </time>
                
                <a href="{{ event.museum.get_url_path }}"><h3>{{ event.museum.title }}</h3></a>
            </header>
            {{ event.get_rendered_description }}
            
            <ul class="tags">
                {% if event.categories.count %}
                    {% for cat in event.categories.all %}
                        <li class="cat"><a href="{% if LANGUAGE_CODE == "de" %}/de/ausstellungen/{% else %}/en/events/{% endif %}#filter=.cat_{{ cat.title|slugify }}">{{ cat.title }}</a></li>
                    {% endfor %}
                {% endif %}
                {% tags_for_object event as tags %}
                {% if tags %}
                    {% for tag in tags %}
                        <li><a href="{% if LANGUAGE_CODE == "de" %}/de/ausstellungen/{% else %}/en/events/{% endif %}#filter=.tag_{{ tag.slug }}">{{ tag.name }}</a></li>
                    {% endfor %}
                {% endif %}
            </ul>   

        </article>
  </div>
</div>

{% include "utils/images.html" %}

{% endwith %}

<div class="content" class="clearfix">
    <div class="inner">
        <h2>Nur noch kurze Zeit</h2>
        <ul id="container" class="list tiles small clearfix">
            {% get_objects closing_soon events.Event 5 as events_closing_soon %}
            {% for event in events_closing_soon %}
                <li class="item">
                    <a class="img" href="{{ event.get_url_path }}" {% if event.cover_image %}data-background="{{ MEDIA_URL }}{{ event.cover_image|modified_path:"event_list" }}{% endif %}">
                        <span class="spinner loading"></span>
                        
                    </a>

                    <nav class="actions">
                        <button rel="tooltip" data-placement="top" data-original-title="{% trans "Add to Favorites" %}" class="favorite icon icon-favorite"></button>
                        <button href="#" rel="tooltip" data-placement="top" data-original-title="{% trans "Show location on map" %}" class="location icon icon-location"></button>
                    </nav>
                    
                    <a href="{{ event.get_url_path }}">
                        <h3>{{ event.museum.title }}</h3>
                        <h4>{{ event.title }}</h4>
                        <h5>{% trans "till" %} {{ event.end|date:"d.m.Y" }}</h5>
                    </a>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>

{% include "utils/gallery.html" %}
{% include "utils/page_controls.html" %}
{% include "utils/gmap_scripts.html" %}
{% include "utils/gallery_scripts.html" %}
{% endblock %}
