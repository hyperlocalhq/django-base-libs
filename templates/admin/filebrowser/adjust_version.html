{% extends "admin/base_site.html" %}

<!-- LOADING -->
{% load i18n fb_tags image_mods_tags base_tags %}
{% load url from future %}

<!-- STYLESHEETS -->
{% block stylesheets %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{{ settings_var.URL_FILEBROWSER_MEDIA }}css/filebrowser.css" />
    <link rel="stylesheet" href="{% url 'jetson_media_url' path='Jcrop/css/jquery.Jcrop.css' %}" type="text/css" />
    <link rel="stylesheet" media="screen" type="text/css" href="{% url 'jetson_media_url' path='colorpicker/css/colorpicker.css' %}" />

    {% if query.pop %}
    <style type="text/css">
        #header { display: none; }
    </style>
    {% endif %}
    
    <style type="text/css">
        .image-version {
            border: 1px solid #D4D4D4;
            background: #fff;
            width: {{ cp_mod.width }}px; 
            height: {{ cp_mod.height }}px;
        }
        #cropbox {
            width: {{ cp_mod.width }}px; 
            height: {{ cp_mod.height }}px;
        }
        .colorpicker input {
            width: auto !important;
            -moz-box-shadow: none;
        }
        #colorSelector {
            position: relative;
            width: 36px;
            height: 36px;
        }
        #colorSelector div {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 28px;
            height: 28px;
            background: url({{ jetson_media_url }}colorpicker/images/select2.png) no-repeat center center;
        }
        .colorpicker {
            z-index: 1000;
        }
        
    </style>
{% endblock %}

<!-- JAVASCRIPTS -->
{% block javascripts %}
    {{ block.super }}
    {{ media }}
    
    <!--
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.0/jquery-ui.min.js"></script>
    -->
    <script>
        var jQuery = grp.jQuery;
    </script>
    
    <script type="text/javascript" src="{% url 'jetson_media_url' path='Jcrop/js/jquery.Jcrop.min.js' %}"></script>
    <script type="text/javascript" src="{% url 'jetson_media_url' path='colorpicker/js/colorpicker.js' %}"></script>
    <script type="text/javascript">
    if (!window.nothing) {
        nothing = function(){};
    }
    //<![CDATA[
    (function($, undefined) {
        var oCroppingAPI;
        var aDefaultSelection = [
            {{ default_initial.x1 }},
            {{ default_initial.y1 }},
            {{ default_initial.x2 }},
            {{ default_initial.y2 }}
        ];
        var sDefaultBgColor = "{{ default_initial.bgcolor }}";
        
        function updateCoords(c) {
            if (c.x == c.x2 || c.y == c.y2) {
                setDefault();
                return
            }
            $('#id_x1').val(c.x);
            $('#id_y1').val(c.y);
            $('#id_x2').val(c.x2);
            $('#id_y2').val(c.y2);
        }
        function setDefault() {
            oCroppingAPI.animateTo(aDefaultSelection);
            updateCoords({
                x: aDefaultSelection[0],
                y: aDefaultSelection[1],
                x2: aDefaultSelection[2],
                y2: aDefaultSelection[3]
            });
            $('#id_bgcolor').val(sDefaultBgColor);
            $('#colorSelector div').css('backgroundColor', sDefaultBgColor);
            updateImage(sDefaultBgColor);
        }
        function updateImage(sBgColor) {
            var sBgColor = sBgColor.replace(/#/, "");
            $(".image-version img").each(function() {
                var sSrc = $(this).attr("src");
                sSrc = sSrc.replace(/[^\/]+\/\?/, sBgColor + '/?');
                $(this).attr("src", sSrc);
            });
        }
        $(window).load(function(){
            var x1 = $('#id_x1').val() || 0;
            var y1 = $('#id_y1').val() || 0;
            var x2 = $('#id_x2').val() || 0;
            var y2 = $('#id_y2').val() || 0;
            var options = {
                onSelect: updateCoords,
                onChange: updateCoords,
                allowSelect: false,
                setSelect: [ x1, y1, x2, y2 ]
            }
            {% if mod.width and mod.height and mod.crop %}
                options['aspectRatio'] = {{ mod.width }} / {{ mod.height }};
            {% endif %}
            oCroppingAPI = $.Jcrop('#cropbox', options);
            $(document).keyup(function(e) {
                // ESCAPE key pressed
                if (e.keyCode == 27) {
                    setDefault();
                }
            });
            $('#colorSelector').ColorPicker({
                livePreview: true,
                onSubmit: function(hsb, hex, rgb, el) {
                    $('#id_bgcolor').val("#" + hex);
                    $('#colorSelector div').css('backgroundColor', '#' + hex);
                    $(el).ColorPickerHide();
                    updateImage(hex);
                },
                onBeforeShow: function () {
                    $(this).ColorPickerSetColor($('#id_bgcolor').val());
                },
                onShow: function (colpkr) {
                    $(colpkr).fadeIn(500);
                    return false;
                },
                onHide: function (colpkr) {
                    $(colpkr).fadeOut(500);
                    return false;
                },
            });
            
            oCroppingAPI.focus();
        });
    }(jQuery));
    //]]>
    </script>

{% endblock %}

<!-- COLTYPE/BODYCLASS -->
{% block coltype %}colM{% endblock %}
{% block bodyclass %}change-list filebrowser{% if query.pop %} popup{% endif %}{% endblock %}

<!-- BREADCRBUMBS -->
{% block breadcrumbs %}{% include "filebrowser/include/breadcrumbs.html" %}{% endblock %}

<!-- CONTENT -->
{% block content %}
    <div id="content-main" class="container-flexible">
        <div class="form-container">
            <form action="" method="post">{% csrf_token %}
                <div>
                    <fieldset class="module aligned">
                        <h2>{% trans "Adjust version" %}</h2>
                        <div class="row">
                            <div class="cell">
                                <div class="image-version">
                                    <img id="cropbox" src="{% url 'image_mods_cropping_preview' bgcolor=form.bgcolor.data|slice:"1:" %}?orig_path={{ fileobject.path }}&amp;sysname={{ mod.sysname }}" alt="" />
                                </div>
                                <p>{% trans "Press ESC to switch to the default selection area and default canvas color." %}</p>
                            </div>
                            <div class="cell">
                                <div class="column span-4">{{ form.bgcolor.label_tag }}</div>
                                <div class="column span-flexible">
                                    {{ form.bgcolor }}
                                    {{ form.bgcolor.errors }}
                                    <div id="colorSelector"><div style="background-color: {{ form.bgcolor.data }};"></div></div>
                                </div>
                            </div>
                        </div>
                        {% if mod.related_mods.count %}
                        <div class="row">
                            <p>{% trans "These modifications will also be affected:" %}</p>
                            {% for rel in mod.related_mods.all %}
                                "{{ rel.title }}"<br />
                            {% endfor %}
                        </div>
                        {% endif %}
                        {{ form.x1 }}{{ form.y1 }}{{ form.x2 }}{{ form.y2 }}
                    </div>
                    <footer class="grp-module grp-submit-row grp-fixed-footer">
                        <header style="display:none"><h1>Submit Options</h1></header>
                        <ul>
                            <li class="grp-float-left cancel-button-container"><a href="{% if query.pop == "1" %}{% url 'filebrowser:fb_detail' %}{% query_string "" "p,sysname" %}{% else %}{% url 'fb_versions' %}{% query_string "" "p,sysname" %}{% endif %}" class="grp-button grp-cancel-link">{% trans "Cancel" %}</a></li>
                            <li><input type="submit" value="{% trans "Crop and save" %}" class="grp-button grp-default" /></li>
                        </ul>
                        <input type="hidden" name="post" value="yes" />
                    </footer>
                </fieldset>
            </form>
        </div>
    </div>
{% endblock %}