/*global self:false, jQuery:false, google:false */(function(e,t){function u(e,t,n){e.setDraggable(!0);google.maps.event.addListener(e,"dragend",function(){var r=e.getPosition();t(r.lat(),r.lng(),n)})}function a(e,t){var n=new google.maps.Geocoder;n.geocode({address:e},function(e,n){n===google.maps.GeocoderStatus.OK?t(e):t(!1)})}var n=window.gettext||function(e){return e},r,i,s,o,f=self.GMapManager={init:function(){var t=self.GMapManager,n=e("#gmap_wrapper").removeClass("hidden");if(n.length){e("#dyn_locate_geo").click(t.recognizeLocation);e("#dyn_remove_geo").click(t.removeGeoPos);var i=e('<div id="gmap">').prependTo(n),o={scrollwheel:!1,zoom:15,center:new google.maps.LatLng(52.523781,13.411895),mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},disableDoubleClickZoom:!0};r=new google.maps.Map(i.get(0),o);google.maps.event.addListener(r,"dblclick",function(n){e("#id_latitude").val(n.latLng.lat());e("#id_longitude").val(n.latLng.lng());t.adjustGeoposition()});s=e('<ul id="gmap_locations">').appendTo(n).hide();t.adjustGeoposition();e("#id_street_address").blur(t.recognizeLocation);e("#id_street_address2").blur(t.recognizeLocation);e("#id_postal_code").blur(t.recognizeLocation);e("#id_city").blur(t.recognizeLocation)}},recognizeLocation:function(){var e=self.GMapManager;a(e.getAddress4search(),e.autocompleteAddress)},removeGeoPos:function(){e("#id_latitude").val("");e("#id_longitude").val("");i.setMap(null)},getAddress4search:function(){var t=[];t.push(e("#id_street_address").val()+" "+e("#id_street_address2").val());t.push(e("#id_city").val());t.push("Germany");t.push(e("#id_postal_code").val());return t.join(", ")},adjustGeoposition:function(){var t=self.GMapManager,n=e("#id_latitude"),r=e("#id_longitude");n.val()&&r.val()&&t.markGeoposition(n.val(),r.val())},drawMarker:function(e){var t=new google.maps.MarkerImage(window.settings.STATIC_URL+"site/img/gmap/markers_1-10.png",new google.maps.Size(20,34),new google.maps.Point(0,340),new google.maps.Point(10,34)),n=new google.maps.MarkerImage(window.settings.STATIC_URL+"site/img/gmap/marker_shadow.png",new google.maps.Size(37,34),new google.maps.Point(0,0),new google.maps.Point(8,25));i=new google.maps.Marker({position:e,map:r,shadow:n,icon:t})},markGeoposition:function(e,t){var n=self.GMapManager,s=new google.maps.LatLng(e,t);if(i){i.setMap(null);i=null}n.drawMarker(s);r.panTo(s,15);u(i,n.correctGeoposition,{bNoSuggest:!0})},correctGeoposition:function(t,n){t=Math.round(t*1e6)/1e6;n=Math.round(n*1e6)/1e6;e("#id_latitude").val(t);e("#id_longitude").val(n)},autocompleteAddress:function(t){function u(){var t=o[e(this).data("gmap_index")],n=t.address_components;f.extractFromXAL(n);var r=t.geometry.location,i=f.correctGeoposition(r.lat(),r.lng(),{});i||f.markGeoposition(r.lat(),r.lng());s.hide();return!1}o=t;s.html("");var r,i=t.length;if(o)if(i>1){for(r=0;r<i;r++)e('<a href="">'+t[r].formatted_address+"</a>").data("gmap_index",r).click(u).appendTo(e("<li>").appendTo(s));e('<a href="">'+n("None of the listed")+"</a>").click(function(){s.hide();return!1}).appendTo(e("<li>").appendTo(s));s.show()}else{s.hide();var a=o[0],l=a.address_components;f.extractFromXAL(l);var c=a.geometry.location,h=f.correctGeoposition(c.lat(),c.lng(),{});h||f.markGeoposition(c.lat(),c.lng())}},extractFromXAL:function(t){var n,r=t.length,i,s;for(n=0;n<r;n++){var o=t[n];switch(o.types[0]){case"locality":document.getElementById("id_city").value=o.long_name;break;case"street_number":s=o.long_name;break;case"route":i=o.long_name;break;case"postal_code":document.getElementById("id_postal_code").value=o.long_name;break;case"country":}}if(i){var u=i;s&&(u+=" "+s);var a=e("#id_street_address");a.val(u)}},destruct:function(){}};e(document).ready(function(){self.GMapManager.init()});e(window).unload(function(){self.GMapManager.destruct()})})(jQuery);