/*global self:false, jQuery:false, google:false */(function(e,t){function n(e,t,n){e.setDraggable(!0);google.maps.event.addListener(e,"dragend",function(){var r=e.getPosition();t(r.lat(),r.lng(),n)})}function r(e,t){var n=new google.maps.Geocoder;n.geocode({address:e},function(e,n){n===google.maps.GeocoderStatus.OK?t(e):t(!1)})}var i=window.gettext||function(e){return e},s,o,u,a,f=self.GMapManager={init:function(){var t=self.GMapManager,n=e("#gmap_wrapper").removeClass("hidden");if(n.length){e("#dyn_locate_geo").click(t.recognizeLocation);e("#dyn_remove_geo").click(t.removeGeoPos);var r=e('<div id="gmap">').prependTo(n),i={mapTypeControl:!1,zoomControl:!0,streetViewControl:!0,scrollwheel:!1,zoom:15,center:new google.maps.LatLng(52.523781,13.411895),mapTypeId:google.maps.MapTypeId.ROADMAP,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL},disableDoubleClickZoom:!0};s=new google.maps.Map(r.get(0),i);google.maps.event.addListener(s,"dblclick",function(n){e("#id_latitude").val(n.latLng.lat());e("#id_longitude").val(n.latLng.lng());t.adjustGeoposition()});u=e('<ul id="gmap_locations">').appendTo(n).hide();t.adjustGeoposition()}},recognizeLocation:function(){var e=self.GMapManager;r(e.getAddress4search(),e.autocompleteAddress)},removeGeoPos:function(){e("#id_latitude").val("");e("#id_longitude").val("");o&&o.setMap(null)},getAddress4search:function(){var t=[];t.push(e("#id_street_address").val()+" "+e("#id_street_address2").val());t.push(e("#id_city").val());t.push("Germany");t.push(e("#id_postal_code").val());return t.join(", ")},adjustGeoposition:function(){var t=self.GMapManager,n=e("#id_latitude"),r=e("#id_longitude");n.val()&&r.val()&&t.markGeoposition(n.val(),r.val())},drawMarker:function(e){var t=new google.maps.MarkerImage(window.settings.STATIC_URL+"site/img/gmap/markers_1-10.png",new google.maps.Size(20,34),new google.maps.Point(0,340),new google.maps.Point(10,34)),n=new google.maps.MarkerImage(window.settings.STATIC_URL+"site/img/gmap/marker_shadow.png",new google.maps.Size(37,34),new google.maps.Point(0,0),new google.maps.Point(8,25));o=new google.maps.Marker({position:e,map:s,shadow:n,icon:t})},markGeoposition:function(e,t){var r=self.GMapManager,i=new google.maps.LatLng(e,t);if(o){o.setMap(null);o=null}r.drawMarker(i);s.panTo(i,15);n(o,r.correctGeoposition,{bNoSuggest:!0})},correctGeoposition:function(t,n){t=Math.round(t*1e6)/1e6;n=Math.round(n*1e6)/1e6;e("#id_latitude").val(t);e("#id_longitude").val(n)},autocompleteAddress:function(t){function n(){var t=a[e(this).data("gmap_index")],n=t.address_components;f.extractFromXAL(n);var r=t.geometry.location,i=f.correctGeoposition(r.lat(),r.lng(),{});i||f.markGeoposition(r.lat(),r.lng());u.hide();return!1}a=t;u.html("");var r,s=t.length;if(a)if(s>1){for(r=0;r<s;r++)e('<a href="">'+t[r].formatted_address+"</a>").data("gmap_index",r).click(n).appendTo(e("<li>").appendTo(u));e('<a href="">'+i("None of the listed")+"</a>").click(function(){u.hide();return!1}).appendTo(e("<li>").appendTo(u));u.show()}else{u.hide();var o=a[0],l=o.address_components;f.extractFromXAL(l);var c=o.geometry.location,h=f.correctGeoposition(c.lat(),c.lng(),{});h||f.markGeoposition(c.lat(),c.lng())}},extractFromXAL:function(t){var n,r=t.length,i,s;for(n=0;n<r;n++){var o=t[n];switch(o.types[0]){case"locality":document.getElementById("id_city").value=o.long_name;break;case"street_number":s=o.long_name;break;case"route":i=o.long_name;break;case"postal_code":document.getElementById("id_postal_code").value=o.long_name;break;case"country":}}if(i){var u=i;s&&(u+=" "+s);var a=e("#id_street_address");a.val(u)}},destruct:function(){}};e(document).ready(function(){self.GMapManager.init()});e(window).unload(function(){self.GMapManager.destruct()})})(jQuery);